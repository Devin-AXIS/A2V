# 🚀 AINO 数据库自动创建功能部署指南

## 📋 功能概述

AINO 项目现在支持**智能数据库检查**功能，可以在新服务器上自动检测数据库状态，并提供清晰的初始化指导。

## ✨ 主要特性

- **🔍 智能检测**: 自动检测数据库是否已初始化
- **📋 清晰指导**: 提供详细的初始化步骤
- **🛡️ 安全启动**: 确保数据库就绪后才启动服务
- **⚡ 一键部署**: 提供完整的部署脚本
- **🔧 零配置**: 使用默认配置即可运行

## 🚀 快速部署

### 方法一：一键部署脚本（推荐）

```bash
# 1. 克隆项目
git clone <your-repo-url>
cd AINO/AINO-server

# 2. 运行一键部署脚本
./deploy.sh
```

### 方法二：手动部署

```bash
# 1. 克隆项目
git clone <your-repo-url>
cd AINO/AINO-server

# 2. 安装依赖
npm install

# 3. 初始化数据库
node scripts/init-database.js

# 4. 启动服务
npm start
```

### 方法三：使用现有脚本

```bash
# 使用数据库初始化脚本
./scripts/setup-database.sh

# 然后启动服务
npm start
```

## 🔧 环境变量配置

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `DB_HOST` | localhost | 数据库主机地址 |
| `DB_PORT` | 5433 | 数据库端口 |
| `DB_USER` | aino | 数据库用户名 |
| `DB_PASSWORD` | pass | 数据库密码 |
| `DB_NAME` | aino | 数据库名称 |
| `NODE_ENV` | development | 运行环境 |
| `PORT` | 3007 | 服务端口 |

## 📊 自动创建的内容

### 核心表结构
- ✅ `users` - 系统用户表
- ✅ `applications` - 应用主表
- ✅ `modules` - 模块定义表
- ✅ `directories` - 数据目录表
- ✅ `application_users` - 应用内用户表
- ✅ `field_categories` - 字段分类表
- ✅ `record_categories` - 记录分类表
- ✅ `directory_defs` - 目录定义表
- ✅ `field_defs` - 字段定义表
- ✅ `relation_records` - 关系记录表
- ✅ `module_installs` - 模块安装记录表
- ✅ `audit_logs` - 审计日志表

### 数据库特性
- ✅ **主键约束** - 所有表的UUID主键
- ✅ **外键约束** - 表间关系完整性
- ✅ **唯一约束** - 防止重复数据
- ✅ **性能索引** - 72个优化索引
- ✅ **UUID扩展** - 自动启用uuid-ossp扩展

### 默认数据
- ✅ **默认管理员** - `admin@aino.com` / `admin123`
- ✅ **默认应用** - `default-app`
- ✅ **默认模块** - 用户管理、数据管理、系统设置

## 🔍 工作原理

### 1. 启动时检查
```
服务启动 → 检查数据库连接 → 检查核心表是否存在 → 自动创建缺失的表
```

### 2. 运行时检测
```
API请求 → 数据库操作 → 检测表不存在错误 → 自动创建表 → 重新执行请求
```

### 3. 智能创建
- 根据错误信息自动推断需要创建的表
- 使用预定义的表结构模板
- 自动创建相关索引和约束

## 🧪 测试功能

### 运行测试脚本
```bash
# 测试自动创建功能
node scripts/test-auto-creation.js
```

### 测试内容
- ✅ 数据库连接测试
- ✅ 表创建功能测试
- ✅ 数据插入/查询测试
- ✅ 字段添加测试
- ✅ 核心表验证测试

## 📝 日志输出示例

```
🚀 启动 AINO 服务器...
📊 初始化数据库...
🔍 检查数据库初始化状态...
✅ 数据库连接正常
🚀 开始自动初始化数据库...
✅ UUID扩展已启用
📋 执行 346 个SQL语句...
✅ 数据库结构创建完成
📋 创建默认数据...
✅ 默认管理员用户创建完成 (admin@aino.com / admin123)
✅ 默认应用创建完成
✅ 默认模块创建完成
✅ 默认数据创建完成
🔍 验证数据库结构...
✅ 发现 17 个表
✅ 发现 72 个索引
✅ 发现 25 个外键约束
✅ 数据库初始化完成
🚀 AINO Server running at http://localhost:3007
✅ 服务器启动完成！
```

## ⚠️ 注意事项

### 安全提醒
1. **修改默认密码**: 生产环境中必须修改默认管理员密码
2. **数据库权限**: 确保数据库用户有创建表的权限
3. **网络访问**: 配置适当的数据库访问控制

### 性能考虑
1. **首次启动**: 首次启动可能需要较长时间创建表结构
2. **索引创建**: 大量索引创建可能影响启动时间
3. **并发控制**: 避免多个实例同时初始化数据库

### 故障排除
1. **连接失败**: 检查数据库服务是否运行
2. **权限不足**: 确保数据库用户有足够权限
3. **端口冲突**: 检查数据库端口是否被占用

## 🔄 升级和维护

### 数据库结构更新
- 新版本会自动检测并创建新的表和字段
- 现有数据不会丢失
- 支持向后兼容

### 手动初始化（备用方案）
如果自动创建失败，仍可使用手动初始化：

```bash
# 执行SQL脚本
psql -h localhost -p 5432 -U aino -d aino -f scripts/init-database.sql

# 执行Node.js脚本
node scripts/init-database.js
```

## 📞 技术支持

如果遇到问题，请检查：
1. 数据库服务是否正常运行
2. 环境变量配置是否正确
3. 数据库用户权限是否足够
4. 网络连接是否正常

---

**🎉 现在您可以在任何新服务器上直接启动 AINO 服务，无需手动配置数据库！**
