module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/node:child_process [external] (node:child_process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:child_process", () => require("node:child_process"));

module.exports = mod;
}),
"[externals]/node:process [external] (node:process, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("node:process", () => require("node:process"));

module.exports = mod;
}),
"[project]/new-flow/A2V/app/api/proxy/[configId]/tools/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/new-flow/A2V/node_modules/.pnpm/next@16.0.0_react-dom@19.2.0_react@19.2.0__react@19.2.0/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/fs [external] (fs, cjs)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/path [external] (path, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f40$modelcontextprotocol$2b$sdk$40$0$2e$5$2e$0$2f$node_modules$2f40$modelcontextprotocol$2f$sdk$2f$dist$2f$client$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/new-flow/A2V/node_modules/.pnpm/@modelcontextprotocol+sdk@0.5.0/node_modules/@modelcontextprotocol/sdk/dist/client/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f40$modelcontextprotocol$2b$sdk$40$0$2e$5$2e$0$2f$node_modules$2f40$modelcontextprotocol$2f$sdk$2f$dist$2f$client$2f$stdio$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/new-flow/A2V/node_modules/.pnpm/@modelcontextprotocol+sdk@0.5.0/node_modules/@modelcontextprotocol/sdk/dist/client/stdio.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f40$modelcontextprotocol$2b$sdk$40$0$2e$5$2e$0$2f$node_modules$2f40$modelcontextprotocol$2f$sdk$2f$dist$2f$client$2f$sse$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/new-flow/A2V/node_modules/.pnpm/@modelcontextprotocol+sdk@0.5.0/node_modules/@modelcontextprotocol/sdk/dist/client/sse.js [app-route] (ecmascript)");
;
;
;
;
;
;
const CONFIGS_FILE = __TURBOPACK__imported__module__$5b$externals$5d2f$path__$5b$external$5d$__$28$path$2c$__cjs$29$__["default"].join(process.cwd(), 'data', 'mcp-configs', 'configs.json');
// 读取配置
async function readConfig(configId) {
    try {
        const data = await __TURBOPACK__imported__module__$5b$externals$5d2f$fs__$5b$external$5d$__$28$fs$2c$__cjs$29$__["promises"].readFile(CONFIGS_FILE, 'utf-8');
        const configs = JSON.parse(data);
        return configs.find((c)=>c.id === configId);
    } catch (error) {
        if (error.code === 'ENOENT') {
            throw new Error('配置文件不存在');
        }
        throw error;
    }
}
// 获取代理会话
function getProxySessions() {
    if (!globalThis.__mcpProxySessions) {
        globalThis.__mcpProxySessions = new Map();
    }
    return globalThis.__mcpProxySessions;
}
// 创建临时MCP客户端会话（用于非SSE请求）
async function createTemporarySession(configId, config) {
    console.log(`[Proxy Tools] 创建临时会话，configId: ${configId}`);
    const mcpClient = new __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f40$modelcontextprotocol$2b$sdk$40$0$2e$5$2e$0$2f$node_modules$2f40$modelcontextprotocol$2f$sdk$2f$dist$2f$client$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["Client"]({
        name: 'mcp-proxy-server',
        version: '1.0.0'
    }, {
        capabilities: {
            tools: {},
            prompts: {},
            resources: {}
        }
    });
    const connectionConfig = config.connectionConfig || {};
    let transport = null;
    // 根据配置类型建立连接
    if (config.connectionType === 'url' && connectionConfig.url) {
        // SSE连接
        const url = new URL(connectionConfig.url);
        transport = new __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f40$modelcontextprotocol$2b$sdk$40$0$2e$5$2e$0$2f$node_modules$2f40$modelcontextprotocol$2f$sdk$2f$dist$2f$client$2f$sse$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["SSEClientTransport"](url);
    } else if (config.connectionType === 'command' && connectionConfig.command) {
        // Stdio连接
        transport = new __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f40$modelcontextprotocol$2b$sdk$40$0$2e$5$2e$0$2f$node_modules$2f40$modelcontextprotocol$2f$sdk$2f$dist$2f$client$2f$stdio$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["StdioClientTransport"]({
            command: connectionConfig.command,
            args: connectionConfig.args || []
        });
    } else if (config.connectionType === 'script' && connectionConfig.script) {
        // 从脚本中提取URL
        const scriptData = typeof connectionConfig.script === 'string' ? JSON.parse(connectionConfig.script) : connectionConfig.script;
        const scriptUrl = scriptData.url || scriptData.sse || scriptData.server && scriptData.server.url;
        if (scriptUrl) {
            transport = new __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f40$modelcontextprotocol$2b$sdk$40$0$2e$5$2e$0$2f$node_modules$2f40$modelcontextprotocol$2f$sdk$2f$dist$2f$client$2f$sse$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["SSEClientTransport"](new URL(scriptUrl));
        } else {
            throw new Error('脚本中未找到有效的URL');
        }
    } else {
        throw new Error(`不支持的连接类型: ${config.connectionType}`);
    }
    if (!transport) {
        throw new Error('无法创建传输层');
    }
    await mcpClient.connect(transport);
    console.log(`[Proxy Tools] 临时会话连接成功，configId: ${configId}`);
    // 保存临时会话
    const sessionId = `temp_${configId}_${Date.now()}`;
    const sessions = getProxySessions();
    sessions.set(sessionId, {
        configId,
        mcpClient,
        transport,
        messageQueue: []
    });
    return mcpClient;
}
async function GET(request, { params }) {
    try {
        const resolvedParams = params instanceof Promise ? await params : params;
        const { configId } = resolvedParams;
        if (!configId) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: '缺少配置ID'
            }, {
                status: 400
            });
        }
        // 读取配置
        const config = await readConfig(configId);
        if (!config) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: '配置不存在'
            }, {
                status: 404
            });
        }
        // 查找代理会话（使用最新的会话）
        const sessions = getProxySessions();
        let mcpClient = null;
        // 查找该配置的最新会话
        for (const [sessionId, session] of sessions.entries()){
            if (session.configId === configId && session.mcpClient) {
                mcpClient = session.mcpClient;
                break;
            }
        }
        // 如果找不到会话，尝试创建临时会话
        if (!mcpClient) {
            try {
                console.log(`[Proxy Tools] 未找到现有会话，尝试创建临时会话，configId: ${configId}`);
                mcpClient = await createTemporarySession(configId, config);
            } catch (error) {
                console.error(`[Proxy Tools] 创建临时会话失败:`, error);
                return __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    success: false,
                    error: '代理会话不存在，且无法创建临时会话',
                    message: error.message
                }, {
                    status: 500
                });
            }
        }
        // 获取工具列表
        const tools = await mcpClient.listTools();
        return __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            tools: tools.tools || []
        });
    } catch (error) {
        console.error('[Proxy Tools] 获取工具列表失败:', error);
        if (error.code === -32601 || error.message?.includes('Method not found')) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: true,
                tools: [],
                message: '该 MCP 服务器不支持工具功能'
            });
        }
        return __TURBOPACK__imported__module__$5b$project$5d2f$new$2d$flow$2f$A2V$2f$node_modules$2f2e$pnpm$2f$next$40$16$2e$0$2e$0_react$2d$dom$40$19$2e$2$2e$0_react$40$19$2e$2$2e$0_$5f$react$40$19$2e$2$2e$0$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: false,
            error: '获取工具列表失败',
            message: error.message
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__0a462cda._.js.map