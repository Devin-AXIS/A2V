{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/wemo/new-flow/A2V/app/api/save-config/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { promises as fs } from 'fs';\nimport path from 'path';\nimport { randomBytes } from 'crypto';\n\ninterface MCPConfig {\n    id: string;\n    title: string;\n    description: string;\n    icon?: string; // 图片URL，不再是base64\n    connectionType: 'url' | 'command' | 'script';\n    connectionConfig: {\n        user?: any;\n        formData?: any;\n        url?: string;\n        command?: string;\n        args?: string[];\n        script?: any;\n        connectionId?: string;\n    };\n    createdAt: string;\n}\n\nconst CONFIGS_DIR = path.join(process.cwd(), 'data', 'mcp-configs');\nconst CONFIGS_FILE = path.join(CONFIGS_DIR, 'configs.json');\n\n// 确保目录存在\nasync function ensureDir() {\n    try {\n        await fs.mkdir(CONFIGS_DIR, { recursive: true });\n    } catch (error) {\n        console.error('创建配置目录失败:', error);\n    }\n}\n\n// 读取所有配置\nasync function readConfigs(): Promise<MCPConfig[]> {\n    try {\n        await ensureDir();\n        const data = await fs.readFile(CONFIGS_FILE, 'utf-8');\n        return JSON.parse(data);\n    } catch (error: any) {\n        if (error.code === 'ENOENT') {\n            return [];\n        }\n        console.error('读取配置失败:', error);\n        return [];\n    }\n}\n\n// 写入所有配置\nasync function writeConfigs(configs: MCPConfig[]) {\n    try {\n        await ensureDir();\n        await fs.writeFile(CONFIGS_FILE, JSON.stringify(configs, null, 2), 'utf-8');\n    } catch (error) {\n        console.error('写入配置失败:', error);\n        throw error;\n    }\n}\n\nexport async function POST(request: NextRequest) {\n    try {\n        const { title, description, icon, connectionType, connectionConfig } = await request.json();\n\n        // 验证必填字段\n        if (!title || !description) {\n            return NextResponse.json(\n                {\n                    success: false,\n                    error: '缺少必填字段',\n                    message: '标题和介绍字段不能为空',\n                },\n                { status: 400 }\n            );\n        }\n\n        if (!connectionType || !connectionConfig) {\n            return NextResponse.json(\n                {\n                    success: false,\n                    error: '缺少连接配置',\n                    message: '连接类型和连接配置不能为空',\n                },\n                { status: 400 }\n            );\n        }\n\n        // 如果 icon 是 base64 格式，需要转换（但新上传的应该已经是 URL）\n        // 这里只保存 URL，不保存 base64\n        let iconUrl = icon;\n        if (icon && icon.startsWith('data:image')) {\n            // 如果是 base64，忽略它（旧数据兼容，新上传应该已经是 URL）\n            console.warn('收到 base64 格式的 icon，已忽略。请使用文件上传 API 上传图片。');\n            iconUrl = undefined;\n        }\n\n        // 生成唯一ID\n        const configId = randomBytes(16).toString('hex');\n\n        // 创建配置对象\n        const newConfig: MCPConfig = {\n            id: configId,\n            title,\n            description,\n            icon: iconUrl, // 保存图片 URL，而不是 base64\n            connectionType,\n            connectionConfig,\n            createdAt: new Date().toISOString(),\n        };\n\n        // 读取现有配置\n        const configs = await readConfigs();\n\n        // 添加新配置\n        configs.push(newConfig);\n\n        // 保存配置\n        await writeConfigs(configs);\n\n        // 生成访问链接\n        // 提供两个链接：配置页面链接和代理SSE链接\n        const configPageUrl = `http://a2vhub.ipollo.ai/config/${configId}`;\n        const proxySseUrl = `http://a2vhub.ipollo.ai/api/proxy/${configId}/sse`;\n\n        return NextResponse.json({\n            success: true,\n            configId,\n            url: configPageUrl, // 保留原有的配置页面链接\n            proxyUrl: proxySseUrl, // 新增代理SSE链接，用于直接MCP连接\n            message: 'MCP配置保存成功',\n        });\n    } catch (error: any) {\n        console.error('保存MCP配置失败:', error);\n        return NextResponse.json(\n            {\n                success: false,\n                error: '保存失败',\n                message: error.message || '保存MCP配置时发生错误',\n            },\n            { status: 500 }\n        );\n    }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAoBA,MAAM,cAAc,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,QAAQ;AACrD,MAAM,eAAe,4GAAI,CAAC,IAAI,CAAC,aAAa;AAE5C,SAAS;AACT,eAAe;IACX,IAAI;QACA,MAAM,yGAAE,CAAC,KAAK,CAAC,aAAa;YAAE,WAAW;QAAK;IAClD,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,aAAa;IAC/B;AACJ;AAEA,SAAS;AACT,eAAe;IACX,IAAI;QACA,MAAM;QACN,MAAM,OAAO,MAAM,yGAAE,CAAC,QAAQ,CAAC,cAAc;QAC7C,OAAO,KAAK,KAAK,CAAC;IACtB,EAAE,OAAO,OAAY;QACjB,IAAI,MAAM,IAAI,KAAK,UAAU;YACzB,OAAO,EAAE;QACb;QACA,QAAQ,KAAK,CAAC,WAAW;QACzB,OAAO,EAAE;IACb;AACJ;AAEA,SAAS;AACT,eAAe,aAAa,OAAoB;IAC5C,IAAI;QACA,MAAM;QACN,MAAM,yGAAE,CAAC,SAAS,CAAC,cAAc,KAAK,SAAS,CAAC,SAAS,MAAM,IAAI;IACvE,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,WAAW;QACzB,MAAM;IACV;AACJ;AAEO,eAAe,KAAK,OAAoB;IAC3C,IAAI;QACA,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,IAAI,EAAE,cAAc,EAAE,gBAAgB,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEzF,SAAS;QACT,IAAI,CAAC,SAAS,CAAC,aAAa;YACxB,OAAO,qSAAY,CAAC,IAAI,CACpB;gBACI,SAAS;gBACT,OAAO;gBACP,SAAS;YACb,GACA;gBAAE,QAAQ;YAAI;QAEtB;QAEA,IAAI,CAAC,kBAAkB,CAAC,kBAAkB;YACtC,OAAO,qSAAY,CAAC,IAAI,CACpB;gBACI,SAAS;gBACT,OAAO;gBACP,SAAS;YACb,GACA;gBAAE,QAAQ;YAAI;QAEtB;QAEA,2CAA2C;QAC3C,uBAAuB;QACvB,IAAI,UAAU;QACd,IAAI,QAAQ,KAAK,UAAU,CAAC,eAAe;YACvC,qCAAqC;YACrC,QAAQ,IAAI,CAAC;YACb,UAAU;QACd;QAEA,SAAS;QACT,MAAM,WAAW,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;QAE1C,SAAS;QACT,MAAM,YAAuB;YACzB,IAAI;YACJ;YACA;YACA,MAAM;YACN;YACA;YACA,WAAW,IAAI,OAAO,WAAW;QACrC;QAEA,SAAS;QACT,MAAM,UAAU,MAAM;QAEtB,QAAQ;QACR,QAAQ,IAAI,CAAC;QAEb,OAAO;QACP,MAAM,aAAa;QAEnB,SAAS;QACT,wBAAwB;QACxB,MAAM,gBAAgB,CAAC,+BAA+B,EAAE,UAAU;QAClE,MAAM,cAAc,CAAC,kCAAkC,EAAE,SAAS,IAAI,CAAC;QAEvE,OAAO,qSAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT;YACA,KAAK;YACL,UAAU;YACV,SAAS;QACb;IACJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,qSAAY,CAAC,IAAI,CACpB;YACI,SAAS;YACT,OAAO;YACP,SAAS,MAAM,OAAO,IAAI;QAC9B,GACA;YAAE,QAAQ;QAAI;IAEtB;AACJ","debugId":null}}]
}