{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/wemo/new-flow/A2V/app/api/upload-image/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { promises as fs } from 'fs';\nimport path from 'path';\nimport { randomBytes } from 'crypto';\n\nconst UPLOADS_DIR = path.join(process.cwd(), 'public', 'uploads');\n\n// 确保上传目录存在\nasync function ensureUploadsDir() {\n    try {\n        await fs.mkdir(UPLOADS_DIR, { recursive: true });\n    } catch (error) {\n        console.error('创建上传目录失败:', error);\n        throw error;\n    }\n}\n\n// 获取文件扩展名\nfunction getFileExtension(filename: string): string {\n    const ext = path.extname(filename).toLowerCase();\n    return ext || '.jpg';\n}\n\nexport async function POST(request: NextRequest) {\n    try {\n        // 确保上传目录存在\n        await ensureUploadsDir();\n\n        // 获取上传的文件\n        const formData = await request.formData();\n        const file = formData.get('file') as File;\n\n        if (!file) {\n            return NextResponse.json(\n                {\n                    success: false,\n                    error: '缺少文件',\n                    message: '请选择要上传的图片文件',\n                },\n                { status: 400 }\n            );\n        }\n\n        // 验证文件类型\n        if (!file.type.startsWith('image/')) {\n            return NextResponse.json(\n                {\n                    success: false,\n                    error: '无效的文件类型',\n                    message: '只能上传图片文件',\n                },\n                { status: 400 }\n            );\n        }\n\n        // 验证文件大小 (max 5MB)\n        const maxSize = 5 * 1024 * 1024; // 5MB\n        if (file.size > maxSize) {\n            return NextResponse.json(\n                {\n                    success: false,\n                    error: '文件过大',\n                    message: '图片大小不能超过5MB',\n                },\n                { status: 400 }\n            );\n        }\n\n        // 生成唯一的文件名\n        const fileExtension = getFileExtension(file.name);\n        const uniqueFilename = `${randomBytes(16).toString('hex')}${fileExtension}`;\n        const filePath = path.join(UPLOADS_DIR, uniqueFilename);\n\n        // 将文件保存到磁盘\n        const bytes = await file.arrayBuffer();\n        const buffer = Buffer.from(bytes);\n        await fs.writeFile(filePath, buffer);\n\n        // 生成文件URL\n        const fileUrl = `/uploads/${uniqueFilename}`;\n\n        return NextResponse.json({\n            success: true,\n            url: fileUrl,\n            message: '图片上传成功',\n        });\n    } catch (error: any) {\n        console.error('上传图片失败:', error);\n        return NextResponse.json(\n            {\n                success: false,\n                error: '上传失败',\n                message: error.message || '上传图片时发生错误',\n            },\n            { status: 500 }\n        );\n    }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,cAAc,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,UAAU;AAEvD,WAAW;AACX,eAAe;IACX,IAAI;QACA,MAAM,yGAAE,CAAC,KAAK,CAAC,aAAa;YAAE,WAAW;QAAK;IAClD,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,aAAa;QAC3B,MAAM;IACV;AACJ;AAEA,UAAU;AACV,SAAS,iBAAiB,QAAgB;IACtC,MAAM,MAAM,4GAAI,CAAC,OAAO,CAAC,UAAU,WAAW;IAC9C,OAAO,OAAO;AAClB;AAEO,eAAe,KAAK,OAAoB;IAC3C,IAAI;QACA,WAAW;QACX,MAAM;QAEN,UAAU;QACV,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,CAAC,MAAM;YACP,OAAO,qSAAY,CAAC,IAAI,CACpB;gBACI,SAAS;gBACT,OAAO;gBACP,SAAS;YACb,GACA;gBAAE,QAAQ;YAAI;QAEtB;QAEA,SAAS;QACT,IAAI,CAAC,KAAK,IAAI,CAAC,UAAU,CAAC,WAAW;YACjC,OAAO,qSAAY,CAAC,IAAI,CACpB;gBACI,SAAS;gBACT,OAAO;gBACP,SAAS;YACb,GACA;gBAAE,QAAQ;YAAI;QAEtB;QAEA,mBAAmB;QACnB,MAAM,UAAU,IAAI,OAAO,MAAM,MAAM;QACvC,IAAI,KAAK,IAAI,GAAG,SAAS;YACrB,OAAO,qSAAY,CAAC,IAAI,CACpB;gBACI,SAAS;gBACT,OAAO;gBACP,SAAS;YACb,GACA;gBAAE,QAAQ;YAAI;QAEtB;QAEA,WAAW;QACX,MAAM,gBAAgB,iBAAiB,KAAK,IAAI;QAChD,MAAM,iBAAiB,GAAG,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC,SAAS,eAAe;QAC3E,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,aAAa;QAExC,WAAW;QACX,MAAM,QAAQ,MAAM,KAAK,WAAW;QACpC,MAAM,SAAS,OAAO,IAAI,CAAC;QAC3B,MAAM,yGAAE,CAAC,SAAS,CAAC,UAAU;QAE7B,UAAU;QACV,MAAM,UAAU,CAAC,SAAS,EAAE,gBAAgB;QAE5C,OAAO,qSAAY,CAAC,IAAI,CAAC;YACrB,SAAS;YACT,KAAK;YACL,SAAS;QACb;IACJ,EAAE,OAAO,OAAY;QACjB,QAAQ,KAAK,CAAC,WAAW;QACzB,OAAO,qSAAY,CAAC,IAAI,CACpB;YACI,SAAS;YACT,OAAO;YACP,SAAS,MAAM,OAAO,IAAI;QAC9B,GACA;YAAE,QAAQ;QAAI;IAEtB;AACJ","debugId":null}}]
}