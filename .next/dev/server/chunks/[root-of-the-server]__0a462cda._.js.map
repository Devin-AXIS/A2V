{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///Users/wemo/new-flow/A2V/app/api/proxy/%5BconfigId%5D/tools/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { promises as fs } from 'fs';\nimport path from 'path';\nimport { Client } from '@modelcontextprotocol/sdk/client/index.js';\nimport { StdioClientTransport } from '@modelcontextprotocol/sdk/client/stdio.js';\nimport { SSEClientTransport } from '@modelcontextprotocol/sdk/client/sse.js';\n\nconst CONFIGS_FILE = path.join(process.cwd(), 'data', 'mcp-configs', 'configs.json');\n\n// 读取配置\nasync function readConfig(configId: string) {\n    try {\n        const data = await fs.readFile(CONFIGS_FILE, 'utf-8');\n        const configs = JSON.parse(data);\n        return configs.find((c: any) => c.id === configId);\n    } catch (error: any) {\n        if (error.code === 'ENOENT') {\n            throw new Error('配置文件不存在');\n        }\n        throw error;\n    }\n}\n\n// 存储活跃的代理会话（与sse路由共享）\ninterface ProxySession {\n    configId: string;\n    mcpClient: any;\n    transport: any;\n    eventSource?: any;\n    messageQueue: any[];\n    controller?: ReadableStreamDefaultController<Uint8Array>; // 改为可选，因为临时会话不需要\n}\n\ndeclare global {\n    // eslint-disable-next-line no-var\n    var __mcpProxySessions: Map<string, ProxySession> | undefined;\n}\n\n// 获取代理会话\nfunction getProxySessions(): Map<string, ProxySession> {\n    if (!globalThis.__mcpProxySessions) {\n        globalThis.__mcpProxySessions = new Map<string, ProxySession>();\n    }\n    return globalThis.__mcpProxySessions;\n}\n\n// 创建临时MCP客户端会话（用于非SSE请求）\nasync function createTemporarySession(configId: string, config: any): Promise<Client> {\n    console.log(`[Proxy Tools] 创建临时会话，configId: ${configId}`);\n\n    const mcpClient = new Client(\n        {\n            name: 'mcp-proxy-server',\n            version: '1.0.0',\n        },\n        {\n            capabilities: {\n                tools: {},\n                prompts: {},\n                resources: {},\n            },\n        }\n    );\n\n    const connectionConfig = config.connectionConfig || {};\n    let transport: StdioClientTransport | SSEClientTransport | null = null;\n\n    // 根据配置类型建立连接\n    if (config.connectionType === 'url' && connectionConfig.url) {\n        // SSE连接\n        const url = new URL(connectionConfig.url);\n        transport = new SSEClientTransport(url);\n    } else if (config.connectionType === 'command' && connectionConfig.command) {\n        // Stdio连接\n        transport = new StdioClientTransport({\n            command: connectionConfig.command,\n            args: connectionConfig.args || [],\n        });\n    } else if (config.connectionType === 'script' && connectionConfig.script) {\n        // 从脚本中提取URL\n        const scriptData = typeof connectionConfig.script === 'string'\n            ? JSON.parse(connectionConfig.script)\n            : connectionConfig.script;\n        const scriptUrl = scriptData.url || scriptData.sse || (scriptData.server && scriptData.server.url);\n        if (scriptUrl) {\n            transport = new SSEClientTransport(new URL(scriptUrl));\n        } else {\n            throw new Error('脚本中未找到有效的URL');\n        }\n    } else {\n        throw new Error(`不支持的连接类型: ${config.connectionType}`);\n    }\n\n    if (!transport) {\n        throw new Error('无法创建传输层');\n    }\n\n    await mcpClient.connect(transport);\n    console.log(`[Proxy Tools] 临时会话连接成功，configId: ${configId}`);\n\n    // 保存临时会话\n    const sessionId = `temp_${configId}_${Date.now()}`;\n    const sessions = getProxySessions();\n    sessions.set(sessionId, {\n        configId,\n        mcpClient,\n        transport,\n        messageQueue: [],\n    });\n\n    return mcpClient;\n}\n\nexport async function GET(\n    request: NextRequest,\n    { params }: { params: Promise<{ configId: string }> | { configId: string } }\n) {\n    try {\n        const resolvedParams = params instanceof Promise ? await params : params;\n        const { configId } = resolvedParams;\n\n        if (!configId) {\n            return NextResponse.json(\n                { success: false, error: '缺少配置ID' },\n                { status: 400 }\n            );\n        }\n\n        // 读取配置\n        const config = await readConfig(configId);\n        if (!config) {\n            return NextResponse.json(\n                { success: false, error: '配置不存在' },\n                { status: 404 }\n            );\n        }\n\n        // 查找代理会话（使用最新的会话）\n        const sessions = getProxySessions();\n        let mcpClient = null;\n\n        // 查找该配置的最新会话\n        for (const [sessionId, session] of sessions.entries()) {\n            if (session.configId === configId && session.mcpClient) {\n                mcpClient = session.mcpClient;\n                break;\n            }\n        }\n\n        // 如果找不到会话，尝试创建临时会话\n        if (!mcpClient) {\n            try {\n                console.log(`[Proxy Tools] 未找到现有会话，尝试创建临时会话，configId: ${configId}`);\n                mcpClient = await createTemporarySession(configId, config);\n            } catch (error: any) {\n                console.error(`[Proxy Tools] 创建临时会话失败:`, error);\n                return NextResponse.json(\n                    { success: false, error: '代理会话不存在，且无法创建临时会话', message: error.message },\n                    { status: 500 }\n                );\n            }\n        }\n\n        // 获取工具列表\n        const tools = await mcpClient.listTools();\n\n        return NextResponse.json({\n            success: true,\n            tools: tools.tools || [],\n        });\n    } catch (error: any) {\n        console.error('[Proxy Tools] 获取工具列表失败:', error);\n\n        if (error.code === -32601 || error.message?.includes('Method not found')) {\n            return NextResponse.json({\n                success: true,\n                tools: [],\n                message: '该 MCP 服务器不支持工具功能',\n            });\n        }\n\n        return NextResponse.json(\n            {\n                success: false,\n                error: '获取工具列表失败',\n                message: error.message,\n            },\n            { status: 500 }\n        );\n    }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}