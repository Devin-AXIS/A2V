{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///Users/wemo/new-flow/A2V/app/api/user-profile/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { promises as fs } from 'fs';\nimport path from 'path';\n\ninterface UserProfile {\n    address: string;\n    avatar: string;\n    name: string;\n    website: string;\n    profession: string;\n    bio: string;\n    updatedAt: string;\n}\n\nconst PROFILES_DIR = path.join(process.cwd(), 'data', 'user-profiles');\nconst PROFILES_FILE = path.join(PROFILES_DIR, 'profiles.json');\n\n// 确保目录存在\nasync function ensureDir() {\n    try {\n        await fs.mkdir(PROFILES_DIR, { recursive: true });\n    } catch (error) {\n        console.error('创建用户信息目录失败:', error);\n    }\n}\n\n// 读取所有用户信息\nasync function readProfiles(): Promise<Record<string, UserProfile>> {\n    try {\n        await ensureDir();\n        const data = await fs.readFile(PROFILES_FILE, 'utf-8');\n        return JSON.parse(data);\n    } catch (error: any) {\n        if (error.code === 'ENOENT') {\n            return {};\n        }\n        console.error('读取用户信息失败:', error);\n        return {};\n    }\n}\n\n// 写入所有用户信息\nasync function writeProfiles(profiles: Record<string, UserProfile>) {\n    try {\n        await ensureDir();\n        await fs.writeFile(PROFILES_FILE, JSON.stringify(profiles, null, 2), 'utf-8');\n    } catch (error) {\n        console.error('写入用户信息失败:', error);\n        throw error;\n    }\n}\n\n// GET: 根据钱包地址获取用户信息\nexport async function GET(request: NextRequest) {\n    try {\n        const { searchParams } = new URL(request.url);\n        const address = searchParams.get('address');\n\n        if (!address) {\n            return NextResponse.json(\n                {\n                    success: false,\n                    error: '缺少钱包地址',\n                    message: '请提供钱包地址参数',\n                },\n                { status: 400 }\n            );\n        }\n\n        const profiles = await readProfiles();\n        const profile = profiles[address.toLowerCase()];\n\n        if (!profile) {\n            return NextResponse.json({\n                success: true,\n                profile: null,\n                message: '未找到用户信息',\n            });\n        }\n\n        // 返回用户信息（不包含地址）\n        const { address: _, ...profileData } = profile;\n        return NextResponse.json({\n            success: true,\n            profile: profileData,\n            message: '获取用户信息成功',\n        });\n    } catch (error: any) {\n        console.error('获取用户信息失败:', error);\n        return NextResponse.json(\n            {\n                success: false,\n                error: '获取失败',\n                message: error.message || '获取用户信息时发生错误',\n            },\n            { status: 500 }\n        );\n    }\n}\n\n// POST: 保存或更新用户信息\nexport async function POST(request: NextRequest) {\n    try {\n        const { address, avatar, name, website, profession, bio } = await request.json();\n\n        // 验证必填字段\n        if (!address) {\n            return NextResponse.json(\n                {\n                    success: false,\n                    error: '缺少钱包地址',\n                    message: '钱包地址不能为空',\n                },\n                { status: 400 }\n            );\n        }\n\n        if (!name || !name.trim()) {\n            return NextResponse.json(\n                {\n                    success: false,\n                    error: '缺少必填字段',\n                    message: '姓名不能为空',\n                },\n                { status: 400 }\n            );\n        }\n\n        // 读取现有用户信息\n        const profiles = await readProfiles();\n        const addressKey = address.toLowerCase();\n\n        // 如果 avatar 是 base64 格式，需要转换（但新上传的应该已经是 URL）\n        // 这里只保存 URL，不保存 base64\n        let avatarUrl = avatar || '';\n        if (avatar && avatar.startsWith('data:image')) {\n            // 如果是 base64，忽略它（旧数据兼容，新上传应该已经是 URL）\n            console.warn('收到 base64 格式的 avatar，已忽略。请使用文件上传 API 上传图片。');\n            avatarUrl = '';\n        }\n\n        // 创建或更新用户信息\n        const profile: UserProfile = {\n            address: addressKey,\n            avatar: avatarUrl, // 保存图片 URL，而不是 base64\n            name: name.trim(),\n            website: website || '',\n            profession: profession || '',\n            bio: bio || '',\n            updatedAt: new Date().toISOString(),\n        };\n\n        profiles[addressKey] = profile;\n\n        // 保存用户信息\n        await writeProfiles(profiles);\n\n        // 返回用户信息（不包含地址）\n        const { address: _, ...profileData } = profile;\n        return NextResponse.json({\n            success: true,\n            profile: profileData,\n            message: '用户信息保存成功',\n        });\n    } catch (error: any) {\n        console.error('保存用户信息失败:', error);\n        return NextResponse.json(\n            {\n                success: false,\n                error: '保存失败',\n                message: error.message || '保存用户信息时发生错误',\n            },\n            { status: 500 }\n        );\n    }\n}\n\n"],"names":[],"mappings":"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","debugId":null}}]
}