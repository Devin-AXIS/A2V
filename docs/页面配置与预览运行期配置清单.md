### AINO 页面配置与预览/运行期配置清单

本文档系统性梳理当前可配置项及其作用范围，涵盖：
- AINO-studio 的 `client-config` 页面中可配置并持久化的字段
- AINO-APP 的 `preview` 与 `p/[id]` 页面在运行期可接受/读取的配置

并列出与之相关的后端持久化接口，便于正确保存与读取（严禁把页面配置仅存于 localStorage；需通过接口写入并在 APP 打开时自动读取）。

---

### 1) Studio 端：client-config 页面可配置项

以下字段来自 `AINO-studio/app/app/[appId]/client-config/page.tsx` 及其交互逻辑（实际字段会随 UI 操作写入/合并到 manifest 或页面配置，并通过接口持久化）。

- **Manifest 顶层**
  - **schemaVersion**: string（例如 "1.0"）
  - **app**:
    - **appKey**: string（应用标识）
    - **locale**: string（例如 "zh-CN" / "en-US"）
    - **defaultLanguage**: string（"zh" / "en"）
    - **theme**: string（主题标识，默认 "default"）
    - **bottomNav**: 底部导航数组
      - 项结构: `{ key: string, label: string, icon?: string, route: string }`
      - 说明: `route` 需以 `/` 开头，可含 `A-Za-z0-9_-` 和 `/`；Studio UI 校验路由格式，并在需要时自动创建对应 `pages[pageKey]`（pageKey 为去掉前导 `/` 的路由，如 `/home` → `home`）。

- **dataSources（数据源定义）**
  - 以字典形式定义：`{ [dsKey: string]: { type: 'table', tableId: string, label?: string, moduleName?: string, tableName?: string } }`
  - 用途：
    - 供卡片在 Studio 侧进行字段映射（通过 `aino:data` 渠道接收卡片入参原型后，进行字段选择与绑定）。
    - Studio 会读取模块/目录/字段元数据，辅助下拉选项与级联选项生成。
  - 字段映射（随 manifest 一并持久化）包含：
    - 绑定的数据源键（或 `table:<id>` 直连表）
    - 输入字段路径 → 数据源字段键 的映射关系

- **pages（页面配置集合）**: `{ [pageKey: string]: PageConfig }`
  - PageConfig 通用字段：
    - **title**: string | `{ zh?: string, en?: string }`
    - **route**: string（如 `/home`）
    - **layout**: "mobile" | "pc"（APP 运行期主要使用 "mobile"；PC 预留）
    - **category**: string（用于动态工作台分类，默认常用值：`workspace` | `content` | `education` 等）
    - （可选）**cards / cardsDefault**: `string[]`（卡片类型名，用于首次渲染时的布局种子）

  - 顶部标签栏与内容导航（新模型，二者可同时或单独使用）
    - **topBar**:
      - `enabled`: boolean（开启顶部标签）
      - `tabs`: `Array<{ id?: string, title: string }>`（标题为空将显示占位“标签”）
    - **tabContent**（与 topBar 搭配使用，按标签索引配置）:
      - 结构：`{ [tabIndex: number]: { contentNav?: ContentNav } }`
    - **contentNav**（页面级内容导航；当 topBar 未开启时生效；若 `type: 'text'` 时也可作为顶部标签使用）:
      - 通用字段：
        - `category`: "navigation" | "status"
        - `style`: "icon" | "text"（Studio 端内部与 APP 端 `type` 做了互转：`style: 'icon'` → `type: 'iconText'`）
      - `type: 'text'`（文本标签条）
        - `items`: `Array<{ title: string }>`（仅文本）
        - 可选 `header`: `{ title?: string, search?: boolean, notify?: boolean }`（渲染头部搜索/通知按钮）
      - `type: 'iconText'`（图文入口栅格/滑动）
        - `layout`: "grid-4" | "grid-5" | "scroll"
        - `items`: `Array<{
            title: string,
            image?: string,
            event?: {
              action?: 'navigate' | 'switchTab',
              pageType?: 'internal' | 'external',
              page?: string,        // 内部页标识（如 'home' 或 'p-123'）
              url?: string,         // 外链
              tabKey?: string,
              tabIndex?: number,
              params?: string       // 追加 query string
            }
          }>`

  - 卡片级增强配置（Overrides & Filters）
    - Studio 可针对某一“分区”与“卡片类型”写入覆盖项：
      - 分区键 `sectionKey`：
        - 当开启顶部标签栏：`tab-<index>`
        - 使用图文内容导航：`icon-<index>`
      - 结构：
```json
{
  "overrides": {
    "tab-0": {
      "card-type-a": {
        "props": { /* 透传给卡片组件的入参 */ },
        "jsx": "/* 可选：以 InlineSandbox 动态渲染 */",
        "display": { "limit": 10 },
        "filters": {
          "enabled": true,
          "fields": [
            { "fieldId": "category", "type": "select", "label": "类别", "options": ["全部", "A", "B"], "default": "all" },
            { "fieldId": "region", "type": "cascader", "label": "地区", "optionsTree": [ /* 树结构 */ ] }
          ]
        }
      }
    }
  }
}
```
    - APP 端行为：
      - `display.limit` 将被注入到卡片 `props.listLimit`
      - `filters` 会自动生成顶部筛选条（`DropdownFilterTabs`），并把选择结果注入至 `props.activeFilters`
      - 如设置 `jsx`，将以沙箱方式渲染替代卡片组件

  - 卡片可见性控制（Visibility）
```json
{
  "visibility": {
    "text": { "0": ["card-type-a", "card-type-b"] },
    "icon": { "1": ["card-type-c"] }
  }
}
```
  - 说明：当存在可见性配置时，仅显示列表中包含的卡片类型；`text` 对应顶部文本标签模式，`icon` 对应图文导航模式。

- **工作台布局（动态页）持久化**
  - 存储键（按页面分类/分区与语言隔离）：
    - `dynamic_page_layout_${categoryOrSection}_${locale}`
      - 当存在顶部标签：`${category}-tab-${index}`
      - 当存在图文导航：`${category}-icon-${index}`
  - 存储结构：
```json
{
  "cards": [ { "id": "card-type-a-<ts>", "type": "card-type-a" } ],
  "themes": { "<cardId>": { /* 主题对象 */ } },
  "dataSources": { "<cardId>": { "key": "dsKey", "label": "数据源名" } },
  "updatedAt": 1736500000000
}
```
  - 后端按“键”同步接口：
    - PUT `http://47.94.52.142:3001/api/page-configs/key/{STORAGE_KEY}`
    - GET `http://47.94.52.142:3001/api/page-configs/key/{STORAGE_KEY}`

---

### 2) APP 端：预览页与 p/[id] 页可配置项

- **[locale]/preview 与 [locale]/preview/[id]**（预览容器）
  - Query 支持：
    - `appId`: 预览通道标识（写入 `APP_ID`）
    - `origin` / `parentOrigin`: 预览 iframe 的父域，用于 postMessage 通讯
    - `data`: JSON 字符串或原始字符串（分别写入 `PREVIEW_SELECTED_DATA` / `PREVIEW_SELECTED_DATA_RAW`）
  - 后端读取：GET `http://47.94.52.142:3001/api/preview-manifests/{id}` → `manifest`
  - 运行期处理：
    - `CURRENT_APP_ID` ← `manifest.app.appKey`
    - 根据 `manifest.app.bottomNav` 生成并写入 `CURRENT_APP_NAV_ITEMS`（供 `BottomNavigation` 使用）
    - 首次为工作台写入布局种子：
      - 类别：`manifest.pages.home.category || "workspace"`
      - 种子：`manifest.pages.home.cardsDefault`（若存在）
      - 存储键：`dynamic_page_layout_${category}_${locale}`
      - 清理历史缓存中的 `mobile-navigation` 卡片遗留

- **[locale]/p/[id]**（页面级预览/运行页）
  - Query 支持：
    - `pageCfg`: 直接传入页面配置（JSON 字符串）
    - `cfgId`: 后端存储 ID（GET `/api/page-configs/{cfgId}` 读取）
    - `tab`: 初始标签索引（数字）
  - 生效配置（写入并读取于 `APP_PAGE_{id}`）：
    - **title**: string | `{ zh?: string, en?: string }`（`AppHeader` 会按 locale 选择）
    - **layout**: "mobile" | "pc"
    - **route**: string（如 `/p-123` 对应路由）
    - **options**:
      - `showHeader`: boolean
      - `showBottomNav`: boolean
      - `showBack`: boolean
      - `aiOpsUrl`: string（右上角入口链接）
      - `aiOpsLabel`: string（入口按钮文案）
    - **topBar / contentNav / tabContent**：同上（Studio 配置模型一致）
    - **cards**: `string[]`（作为 `dynamic_page_layout_p-{id}_{locale}` 的初始布局种子）
    - **overrides / visibility**：同 Studio 端说明（APP 端按分区键解析并应用）
  - 辅助键：
    - `APP_PAGE_ROUTE_/p-{id}`: 以“路由”为键存一份页面配置（供底部导航或其他逻辑判断）

- **[locale]/app/[appKey]**（已发布的应用运行页）
  - 后端读取：GET `http://47.94.52.142:3001/api/apps/{appKey}/manifest?state=published`
  - 路由选择：
    - Query `route`（将 `/me` 归一化为 `/profile`）
    - 未显式给出时回退到 `manifest.pages.home.route || '/home'`
  - 当前页面键解析：先在 `manifest.pages` 中以 `route` 精确匹配，失败时从 `route` 推导为 pageKey（去掉前导 `/`）
  - `category`：取 `manifest.pages[currentPageKey].category || 'workspace'`
  - `BottomNavigation`：根据 `APPLICATION_CONFIG.config.clientManifest.app.bottomNav` 或 `CURRENT_APP_NAV_ITEMS` 决定显示与内容

---

### 3) 后端相关接口（持久化/读取）

- **应用 Manifest**
  - GET  `/api/apps/:appId/manifest?state=draft|published`
  - PUT  `/api/apps/:appId/manifest?state=draft|published`（Body: `{ manifest: any }`）
  - POST `/api/apps/:appId/manifest/publish`（Body: `{ from?: 'draft' }`）

- **页面配置（自由 JSON）**
  - POST `/api/page-configs`（Body: 任意 JSON）→ `{ id }`
  - GET  `/api/page-configs/:id`

- **页面配置（按 Key 持久化）**
  - PUT `/api/page-configs/key/:key`（Body: 直接 JSON 或 `{ payload: any }`）
  - GET `/api/page-configs/key/:key`

> 实施要求：Studio 页面配置的保存必须通过上述接口写入（数据库或 JSON 文件），并在 APP 页面打开时自动读取与应用；严禁将配置仅存于 localStorage。

---

### 4) 配置示例片段

- **页面级 pageCfg（用于 `/p/[id]` 的 pageCfg/cfgId）**
```json
{
  "title": { "zh": "首页", "en": "Home" },
  "layout": "mobile",
  "route": "/p-123",
  "options": { "showHeader": true, "showBottomNav": false, "showBack": false, "aiOpsUrl": "https://ops.example.com", "aiOpsLabel": "AI运营" },
  "topBar": { "enabled": true, "tabs": [ { "title": "推荐" }, { "title": "最新" } ] },
  "tabContent": {
    "0": { "contentNav": { "category": "navigation", "style": "icon", "layout": "grid-4", "items": [ { "title": "课程", "image": "...", "event": { "action": "navigate", "pageType": "internal", "page": "courses" } } ] } },
    "1": { "contentNav": { "category": "navigation", "style": "text", "items": [ { "title": "全部" }, { "title": "精选" } ] } }
  },
  "contentNav": { "category": "navigation", "style": "icon", "layout": "scroll", "items": [ { "title": "外链", "event": { "action": "navigate", "pageType": "external", "url": "https://example.com" } } ] },
  "cards": ["universal-info", "quick-actions"],
  "overrides": {
    "tab-0": {
      "universal-info": {
        "props": { "title": "概况", "source": "系统统计" },
        "display": { "limit": 4 },
        "filters": { "enabled": true, "fields": [ { "fieldId": "category", "type": "select", "label": "类别", "options": ["全部", "A", "B"], "default": "all" } ] }
      }
    }
  },
  "visibility": { "text": { "0": ["universal-info"] }, "icon": {} }
}
```

- **Manifest 片段（运行期 APP）**
```json
{
  "schemaVersion": "1.0",
  "app": {
    "appKey": "demo-app",
    "locale": "zh-CN",
    "theme": "default",
    "bottomNav": [
      { "key": "home", "label": "首页", "icon": "home", "route": "/home" },
      { "key": "profile", "label": "我的", "icon": "user", "route": "/profile" }
    ]
  },
  "pages": {
    "home": {
      "title": { "zh": "首页", "en": "Home" },
      "route": "/home",
      "layout": "mobile",
      "category": "workspace",
      "cardsDefault": ["universal-info", "quick-actions"]
    }
  }
}
```

---

### 5) 要点与建议

- **持久化策略**：Studio 配置变更后，应调用接口保存；APP 打开页面时应优先从后端读取（必要时再回落到本地缓存）。
- **布局隔离**：顶部标签或图文导航会改变布局存储键（`tab-idx`/`icon-idx`），同一页面不同分区互不干扰。
- **导航/跳转**：内容导航项的 `event` 同时支持内部路由与外链；内部 `page` 支持普通页（`home` → `/{locale}/home`）以及 `p-<id>`（→ `/{locale}/p/<id>`）。
- **筛选与展示**：`filters` 与 `display.limit` 面向卡片级控制；`visibility` 面向分区-卡片的显示白名单。


