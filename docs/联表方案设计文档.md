# AINO è”è¡¨æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† AINO å¹³å°çš„è”è¡¨æ–¹æ¡ˆè®¾è®¡ï¼Œè¯¥æ–¹æ¡ˆåŸºäºå…³ç³»å‹æ•°æ®åº“çš„å…³è”è¡¨æ¨¡å¼ï¼Œæ”¯æŒå¤æ‚çš„è®°å½•é—´å…³è”å…³ç³»ï¼Œä¸ºå¹³å°æä¾›çµæ´»çš„æ•°æ®å…³è”èƒ½åŠ›ã€‚

### âœ… æ ¸å¿ƒç‰¹æ€§

#### 1. ç»Ÿä¸€å…³è”è¡¨è®¾è®¡
- **å•ä¸€å…³è”è¡¨**ï¼šä½¿ç”¨ `relation_records` è¡¨ç»Ÿä¸€ç®¡ç†æ‰€æœ‰è®°å½•é—´çš„å…³è”å…³ç³»
- **åŒå‘å…³è”æ”¯æŒ**ï¼šæ”¯æŒå•å‘å’ŒåŒå‘å…³è”å…³ç³»
- **å¤šç§å…³è”ç±»å‹**ï¼šæ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šå…³è”
- **çº§è”åˆ é™¤**ï¼šæ”¯æŒå…³è”åˆ é™¤ç­–ç•¥ï¼ˆcascadeã€restrictã€set_nullï¼‰

#### 2. é«˜æ€§èƒ½æŸ¥è¯¢ä¼˜åŒ–
- **å¤åˆç´¢å¼•**ï¼šé’ˆå¯¹æŸ¥è¯¢åœºæ™¯ä¼˜åŒ–çš„å¤åˆç´¢å¼•è®¾è®¡
- **å”¯ä¸€çº¦æŸ**ï¼šé˜²æ­¢é‡å¤å…³è”å…³ç³»
- **åˆ†é¡µæŸ¥è¯¢**ï¼šæ”¯æŒå¤§é‡å…³è”æ•°æ®çš„åˆ†é¡µæŸ¥è¯¢

#### 3. æ•°æ®ä¸€è‡´æ€§ä¿éšœ
- **äº‹åŠ¡å¤„ç†**ï¼šå…³è”å…³ç³»çš„åˆ›å»ºå’Œåˆ é™¤åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
- **åŒæ­¥æœºåˆ¶**ï¼šå­—æ®µå€¼å˜æ›´æ—¶è‡ªåŠ¨åŒæ­¥å…³è”å…³ç³»
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶

## ğŸ—ï¸ æ•°æ®åº“è®¾è®¡

### å…³è”è¡¨ç»“æ„

```sql
-- å…³è”å…³ç³»è¡¨
CREATE TABLE "relation_records" (
    "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
    "application_id" uuid NOT NULL,
    "from_directory_id" uuid NOT NULL,
    "from_record_id" uuid NOT NULL,
    "from_field_key" text NOT NULL,
    "to_directory_id" uuid NOT NULL,
    "to_record_id" uuid NOT NULL,
    "to_field_key" text,
    "relation_type" text NOT NULL,
    "bidirectional" boolean DEFAULT false,
    "created_at" timestamp with time zone DEFAULT now(),
    "updated_at" timestamp with time zone DEFAULT now(),
    "created_by" uuid
);
```

### å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | uuid | ä¸»é”®ï¼Œè‡ªåŠ¨ç”Ÿæˆ |
| `application_id` | uuid | åº”ç”¨IDï¼Œå¤–é”®å…³è”åˆ°applicationsè¡¨ |
| `from_directory_id` | uuid | æºç›®å½•IDï¼Œå¤–é”®å…³è”åˆ°directory_defsè¡¨ |
| `from_record_id` | uuid | æºè®°å½•ID |
| `from_field_key` | text | æºå­—æ®µé”®å |
| `to_directory_id` | uuid | ç›®æ ‡ç›®å½•IDï¼Œå¤–é”®å…³è”åˆ°directory_defsè¡¨ |
| `to_record_id` | uuid | ç›®æ ‡è®°å½•ID |
| `to_field_key` | text | ç›®æ ‡å­—æ®µé”®åï¼ˆåŒå‘å…³è”æ—¶ä½¿ç”¨ï¼‰ |
| `relation_type` | text | å…³è”ç±»å‹ï¼š'one_to_one', 'one_to_many', 'many_to_many' |
| `bidirectional` | boolean | æ˜¯å¦ä¸ºåŒå‘å…³è” |
| `created_at` | timestamp | åˆ›å»ºæ—¶é—´ |
| `updated_at` | timestamp | æ›´æ–°æ—¶é—´ |
| `created_by` | uuid | åˆ›å»ºè€…ID |

### å¤–é”®çº¦æŸ

```sql
-- åº”ç”¨çº§è”åˆ é™¤
ALTER TABLE "relation_records" 
ADD CONSTRAINT "relation_records_application_id_applications_id_fk" 
FOREIGN KEY ("application_id") REFERENCES "applications"("id") 
ON DELETE cascade ON UPDATE no action;

-- æºç›®å½•çº§è”åˆ é™¤
ALTER TABLE "relation_records" 
ADD CONSTRAINT "relation_records_from_directory_id_directory_defs_id_fk" 
FOREIGN KEY ("from_directory_id") REFERENCES "directory_defs"("id") 
ON DELETE cascade ON UPDATE no action;

-- ç›®æ ‡ç›®å½•çº§è”åˆ é™¤
ALTER TABLE "relation_records" 
ADD CONSTRAINT "relation_records_to_directory_id_directory_defs_id_fk" 
FOREIGN KEY ("to_directory_id") REFERENCES "directory_defs"("id") 
ON DELETE cascade ON UPDATE no action;
```

### ç´¢å¼•è®¾è®¡

```sql
-- æ—¶é—´ç´¢å¼•
CREATE INDEX "relation_records_created_at_idx" ON "relation_records" ("created_at");

-- æºè®°å½•æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_from_idx" ON "relation_records" 
("from_directory_id", "from_record_id", "from_field_key");

-- ç›®æ ‡è®°å½•æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_to_idx" ON "relation_records" 
("to_directory_id", "to_record_id", "to_field_key");

-- åº”ç”¨æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_app_idx" ON "relation_records" ("application_id");

-- å”¯ä¸€çº¦æŸï¼ˆé˜²æ­¢é‡å¤å…³è”ï¼‰
ALTER TABLE "relation_records" 
ADD CONSTRAINT "relation_records_unique" 
UNIQUE("from_directory_id", "from_record_id", "from_field_key", "to_directory_id", "to_record_id");
```

## ğŸ”§ å…³è”ç±»å‹è®¾è®¡

### 1. ä¸€å¯¹ä¸€å…³è” (one_to_one)

```typescript
// å­—æ®µé…ç½®
{
  key: 'manager',
  kind: 'relation',
  type: 'relation_one',
  relation: {
    targetDirId: 'employees',
    mode: 'one',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'reports',
    onDelete: 'restrict'
  }
}
```

**ç‰¹ç‚¹**ï¼š
- æ¯ä¸ªæºè®°å½•æœ€å¤šå…³è”ä¸€ä¸ªç›®æ ‡è®°å½•
- æ”¯æŒåŒå‘å…³è”
- åˆ é™¤æ—¶æ ¹æ® `onDelete` ç­–ç•¥å¤„ç†

### 2. ä¸€å¯¹å¤šå…³è” (one_to_many)

```typescript
// å­—æ®µé…ç½®
{
  key: 'employees',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'employees',
    mode: 'many',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'department',
    onDelete: 'cascade'
  }
}
```

**ç‰¹ç‚¹**ï¼š
- æ¯ä¸ªæºè®°å½•å¯ä»¥å…³è”å¤šä¸ªç›®æ ‡è®°å½•
- æ”¯æŒåŒå‘å…³è”
- æ‰¹é‡åˆ›å»ºå’Œåˆ é™¤å…³è”å…³ç³»

### 3. å¤šå¯¹å¤šå…³è” (many_to_many)

```typescript
// å­—æ®µé…ç½®
{
  key: 'skills',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'skills',
    mode: 'many',
    displayFieldKey: 'name',
    bidirectional: false,
    onDelete: 'restrict'
  }
}
```

**ç‰¹ç‚¹**ï¼š
- å¤šä¸ªæºè®°å½•å¯ä»¥å…³è”å¤šä¸ªç›®æ ‡è®°å½•
- é€šè¿‡å…³è”è¡¨å®ç°å¤šå¯¹å¤šå…³ç³»
- æ”¯æŒå¤æ‚çš„å…³è”æŸ¥è¯¢

## ğŸš€ æ ¸å¿ƒæœåŠ¡è®¾è®¡

### 1. å…³è”å…³ç³»æœåŠ¡ (RelationRecordsService)

```typescript
export class RelationRecordsService {
  // åˆ›å»ºå…³è”å…³ç³»
  async createRelation(data: CreateRelationRequest): Promise<RelationResponse>
  
  // æ‰¹é‡åˆ›å»ºå…³è”å…³ç³»
  async batchCreateRelations(data: BatchCreateRelationRequest): Promise<RelationResponse[]>
  
  // åˆ é™¤å…³è”å…³ç³»
  async deleteRelation(data: DeleteRelationRequest): Promise<void>
  
  // åˆ é™¤å­—æ®µçš„æ‰€æœ‰å…³è”å…³ç³»
  async deleteFieldRelations(applicationId: string, directoryId: string, recordId: string, fieldKey: string): Promise<void>
  
  // åˆ é™¤è®°å½•çš„æ‰€æœ‰å…³è”å…³ç³»
  async deleteRecordRelations(applicationId: string, directoryId: string, recordId: string): Promise<void>
  
  // è·å–å…³è”å…³ç³»åˆ—è¡¨
  async getRelations(params: GetRelationsRequest): Promise<RelationsListResponse>
  
  // è·å–å…³è”çš„è®°å½•
  async getRelatedRecords(applicationId: string, directoryId: string, recordId: string, fieldKey: string, page?: number, limit?: number): Promise<RelatedRecordsListResponse>
  
  // åŒæ­¥å…³è”å…³ç³»ï¼ˆå­—æ®µå€¼å˜æ›´æ—¶è°ƒç”¨ï¼‰
  async syncRelations(applicationId: string, directoryId: string, recordId: string, fieldKey: string, newValue: any, fieldConfig: any): Promise<void>
}
```

### 2. å…³è”åŒæ­¥æœåŠ¡ (RelationSyncService)

```typescript
export class RelationSyncService {
  // åŒæ­¥å…³è”å­—æ®µçš„å…³è”å…³ç³»
  async syncRelationField(fieldDef: FieldDef, newValue: any, oldValue: any, context: RelationSyncContext): Promise<void>
  
  // æ‰¹é‡åŒæ­¥å…³è”å­—æ®µ
  async syncRelationFields(fieldDefs: FieldDef[], newRecord: Record<string, any>, oldRecord: Record<string, any>, context: RelationSyncContext): Promise<void>
  
  // åˆ é™¤è®°å½•æ—¶æ¸…ç†å…³è”å…³ç³»
  async cleanupRecordRelations(context: RelationSyncContext): Promise<void>
  
  // è·å–å…³è”çš„è®°å½•
  async getRelatedRecords(context: RelationSyncContext, fieldKey: string, page?: number, limit?: number): Promise<RelatedRecordsListResponse>
}
```

## ğŸ“Š æ•°æ®æµè½¬è®¾è®¡

### 1. åˆ›å»ºå…³è”å…³ç³»æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è®¾ç½®å…³è”å­—æ®µå€¼] --> B[å­—æ®µå¤„ç†å™¨åºåˆ—åŒ–]
    B --> C[ä¿å­˜è®°å½•åˆ°æ•°æ®åº“]
    C --> D[è§¦å‘å…³è”åŒæ­¥æœåŠ¡]
    D --> E[åˆ é™¤æ—§å…³è”å…³ç³»]
    E --> F[åˆ›å»ºæ–°å…³è”å…³ç³»]
    F --> G[æ›´æ–°å…³è”è¡¨]
    G --> H[è¿”å›æˆåŠŸå“åº”]
```

### 2. æŸ¥è¯¢å…³è”è®°å½•æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·æŸ¥è¯¢å…³è”è®°å½•] --> B[è°ƒç”¨å…³è”æœåŠ¡]
    B --> C[æ ¹æ®ç´¢å¼•æŸ¥è¯¢å…³è”è¡¨]
    C --> D[è·å–ç›®æ ‡è®°å½•IDåˆ—è¡¨]
    D --> E[æŸ¥è¯¢ç›®æ ‡è®°å½•è¯¦æƒ…]
    E --> F[ç»„è£…è¿”å›æ•°æ®]
    F --> G[è¿”å›åˆ†é¡µç»“æœ]
```

### 3. åˆ é™¤è®°å½•æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·åˆ é™¤è®°å½•] --> B[æ£€æŸ¥å…³è”å…³ç³»]
    B --> C{æ ¹æ®onDeleteç­–ç•¥}
    C -->|cascade| D[çº§è”åˆ é™¤å…³è”è®°å½•]
    C -->|restrict| E[æ£€æŸ¥æ˜¯å¦æœ‰å…³è”]
    C -->|set_null| F[è®¾ç½®å…³è”å­—æ®µä¸ºnull]
    E --> G{æ˜¯å¦æœ‰å…³è”}
    G -->|æ˜¯| H[æ‹’ç»åˆ é™¤]
    G -->|å¦| I[åˆ é™¤è®°å½•]
    D --> I
    F --> I
    I --> J[æ¸…ç†å…³è”å…³ç³»]
    J --> K[è¿”å›æˆåŠŸå“åº”]
```

## ğŸ” æŸ¥è¯¢ä¼˜åŒ–è®¾è®¡

### 1. ç´¢å¼•ç­–ç•¥

```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX "relation_records_from_idx" ON "relation_records" 
("from_directory_id", "from_record_id", "from_field_key");

CREATE INDEX "relation_records_to_idx" ON "relation_records" 
("to_directory_id", "to_record_id", "to_field_key");

-- åº”ç”¨çº§æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_app_idx" ON "relation_records" ("application_id");
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```typescript
// åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
async getRelatedRecords(
  applicationId: string,
  directoryId: string,
  recordId: string,
  fieldKey: string,
  page: number = 1,
  limit: number = 20
): Promise<RelatedRecordsListResponse> {
  const offset = (page - 1) * limit;
  
  // ä½¿ç”¨å¤åˆç´¢å¼•å¿«é€Ÿå®šä½å…³è”å…³ç³»
  const relations = await this.repo.findByFromRecord(
    applicationId, directoryId, recordId, fieldKey, limit, offset
  );
  
  // æ‰¹é‡æŸ¥è¯¢ç›®æ ‡è®°å½•
  const recordIds = relations.map(r => r.toRecordId);
  const records = await this.recordService.getRecordsByIds(recordIds);
  
  return {
    records: records.map(record => ({
      id: record.id,
      directoryId: record.directoryId,
      directoryName: record.directoryName,
      data: record.data,
      relationType: 'one_to_many',
      createdAt: record.createdAt
    })),
    total: relations.length,
    page,
    limit,
    totalPages: Math.ceil(relations.length / limit)
  };
}
```

## ğŸ›¡ï¸ æ•°æ®ä¸€è‡´æ€§ä¿éšœ

### 1. äº‹åŠ¡å¤„ç†

```typescript
// æ‰¹é‡åˆ›å»ºå…³è”å…³ç³»æ—¶ä½¿ç”¨äº‹åŠ¡
async batchCreateRelations(data: BatchCreateRelationRequest): Promise<RelationResponse[]> {
  return await db.transaction(async (tx) => {
    const relations = [];
    for (const relationData of data.relations) {
      const relation = await tx.insert(relationRecords).values({
        applicationId: data.applicationId,
        ...relationData,
        createdBy: null, // TODO: ä»ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·ID
      }).returning();
      relations.push(relation[0]);
    }
    return relations;
  });
}
```

### 2. é”™è¯¯å¤„ç†

```typescript
// å…³è”åŒæ­¥æ—¶çš„é”™è¯¯å¤„ç†
async syncRelationField(fieldDef: FieldDef, newValue: any, oldValue: any, context: RelationSyncContext) {
  try {
    // åˆ é™¤æ—§çš„å…³è”å…³ç³»
    await this.relationService.deleteFieldRelations(
      context.applicationId,
      context.directoryId,
      context.recordId,
      fieldDef.key
    );

    // åˆ›å»ºæ–°çš„å…³è”å…³ç³»
    if (newValue) {
      // ... åˆ›å»ºé€»è¾‘
    }
  } catch (error) {
    console.error('åŒæ­¥å…³è”å…³ç³»å¤±è´¥:', error);
    // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“ä¸»æµç¨‹
  }
}
```

### 3. æ•°æ®éªŒè¯

```typescript
// å…³è”å…³ç³»æ•°æ®éªŒè¯
export const CreateRelationRequest = z.object({
  applicationId: z.string().uuid(),
  fromDirectoryId: z.string().uuid(),
  fromRecordId: z.string().uuid(),
  fromFieldKey: z.string(),
  toDirectoryId: z.string().uuid(),
  toRecordId: z.string().uuid(),
  toFieldKey: z.string().optional(),
  relationType: RelationTypeEnum,
  bidirectional: z.boolean().default(false),
});
```

## ğŸ¯ ä¸šåŠ¡åœºæ™¯æ”¯æŒ

### 1. ç”¨æˆ·-éƒ¨é—¨å…³è”

```typescript
// ç”¨æˆ·è¡¨çš„éƒ¨é—¨å­—æ®µ
{
  key: 'department',
  kind: 'relation',
  type: 'relation_one',
  relation: {
    targetDirId: 'departments',
    mode: 'one',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'employees',
    onDelete: 'restrict'
  }
}

// éƒ¨é—¨è¡¨çš„å‘˜å·¥å­—æ®µ
{
  key: 'employees',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'employees',
    mode: 'many',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'department',
    onDelete: 'cascade'
  }
}
```

### 2. é¡¹ç›®-ä»»åŠ¡å…³è”

```typescript
// é¡¹ç›®è¡¨çš„ä»»åŠ¡å­—æ®µ
{
  key: 'tasks',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'tasks',
    mode: 'many',
    displayFieldKey: 'title',
    bidirectional: true,
    reverseFieldKey: 'project',
    onDelete: 'cascade'
  }
}

// ä»»åŠ¡è¡¨çš„é¡¹ç›®å­—æ®µ
{
  key: 'project',
  kind: 'relation',
  type: 'relation_one',
  relation: {
    targetDirId: 'projects',
    mode: 'one',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'tasks',
    onDelete: 'restrict'
  }
}
```

### 3. ç”¨æˆ·-æŠ€èƒ½å…³è”

```typescript
// ç”¨æˆ·è¡¨çš„æŠ€èƒ½å­—æ®µ
{
  key: 'skills',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'skills',
    mode: 'many',
    displayFieldKey: 'name',
    bidirectional: false,
    onDelete: 'restrict'
  }
}
```

## ğŸ”§ API æ¥å£è®¾è®¡

### 1. å…³è”å…³ç³»ç®¡ç†æ¥å£

```typescript
// åˆ›å»ºå…³è”å…³ç³»
POST /api/relations
{
  "applicationId": "uuid",
  "fromDirectoryId": "uuid",
  "fromRecordId": "uuid",
  "fromFieldKey": "string",
  "toDirectoryId": "uuid",
  "toRecordId": "uuid",
  "toFieldKey": "string",
  "relationType": "one_to_one" | "one_to_many" | "many_to_many",
  "bidirectional": boolean
}

// æ‰¹é‡åˆ›å»ºå…³è”å…³ç³»
POST /api/relations/batch
{
  "applicationId": "uuid",
  "relations": [...]
}

// åˆ é™¤å…³è”å…³ç³»
DELETE /api/relations
{
  "applicationId": "uuid",
  "fromDirectoryId": "uuid",
  "fromRecordId": "uuid",
  "fromFieldKey": "string",
  "toDirectoryId": "uuid",
  "toRecordId": "uuid"
}

// æŸ¥è¯¢å…³è”å…³ç³»
GET /api/relations?applicationId=uuid&directoryId=uuid&recordId=uuid&fieldKey=string&page=1&limit=20
```

### 2. å…³è”è®°å½•æŸ¥è¯¢æ¥å£

```typescript
// è·å–å…³è”çš„è®°å½•
GET /api/records/:directoryId/:recordId/relations/:fieldKey?page=1&limit=20

// å“åº”æ ¼å¼
{
  "success": true,
  "data": {
    "records": [
      {
        "id": "uuid",
        "directoryId": "uuid",
        "directoryName": "string",
        "data": {...},
        "relationType": "one_to_many",
        "createdAt": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 20,
    "totalPages": 5
  }
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ä¼˜åŒ–

```sql
-- æ ¹æ®æŸ¥è¯¢æ¨¡å¼æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX "relation_records_from_field_idx" ON "relation_records" 
("from_directory_id", "from_field_key", "created_at");

-- åŒå‘å…³è”æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_bidirectional_idx" ON "relation_records" 
("to_directory_id", "to_field_key", "from_directory_id", "from_field_key");
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨ EXISTS å­æŸ¥è¯¢ä¼˜åŒ–å…³è”æŸ¥è¯¢
async getRelatedRecordsOptimized(params: GetRelatedRecordsParams) {
  const query = db
    .select()
    .from(targetTable)
    .where(
      exists(
        db
          .select()
          .from(relationRecords)
          .where(
            and(
              eq(relationRecords.fromDirectoryId, params.directoryId),
              eq(relationRecords.fromRecordId, params.recordId),
              eq(relationRecords.fromFieldKey, params.fieldKey),
              eq(relationRecords.toDirectoryId, params.targetDirectoryId),
              eq(relationRecords.toRecordId, targetTable.id)
            )
          )
      )
    );
    
  return await query;
}
```

### 3. ç¼“å­˜ç­–ç•¥

```typescript
// å…³è”å…³ç³»ç¼“å­˜
class RelationCache {
  private cache = new Map<string, any>();
  
  async getRelatedRecords(key: string): Promise<any> {
    if (this.cache.has(key)) {
      return this.cache.get(key);
    }
    
    const data = await this.relationService.getRelatedRecords(key);
    this.cache.set(key, data);
    
    // è®¾ç½®è¿‡æœŸæ—¶é—´
    setTimeout(() => this.cache.delete(key), 5 * 60 * 1000); // 5åˆ†é’Ÿ
    
    return data;
  }
}
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§

- **äº‹åŠ¡å¤„ç†**ï¼šå…³è”å…³ç³»çš„åˆ›å»ºå’Œåˆ é™¤å¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
- **çº§è”åˆ é™¤**ï¼šåˆ é™¤è®°å½•æ—¶éœ€è¦æ ¹æ® `onDelete` ç­–ç•¥å¤„ç†å…³è”å…³ç³»
- **åŒå‘åŒæ­¥**ï¼šåŒå‘å…³è”æ—¶éœ€è¦åŒæ­¥æ›´æ–°ä¸¤ç«¯çš„å…³è”å…³ç³»

### 2. æ€§èƒ½è€ƒè™‘

- **ç´¢å¼•ä¼˜åŒ–**ï¼šæ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡åˆé€‚çš„å¤åˆç´¢å¼•
- **åˆ†é¡µæŸ¥è¯¢**ï¼šå¤§é‡å…³è”æ•°æ®å¿…é¡»ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢
- **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡åˆ›å»ºå…³è”å…³ç³»æ—¶ä½¿ç”¨äº‹åŠ¡å’Œæ‰¹é‡æ’å…¥

### 3. é”™è¯¯å¤„ç†

- **å¤–é”®çº¦æŸ**ï¼šåˆ é™¤ç›®å½•æˆ–è®°å½•æ—¶éœ€è¦å¤„ç†å¤–é”®çº¦æŸ
- **å”¯ä¸€çº¦æŸ**ï¼šé˜²æ­¢åˆ›å»ºé‡å¤çš„å…³è”å…³ç³»
- **æ•°æ®éªŒè¯**ï¼šåˆ›å»ºå…³è”å…³ç³»å‰éªŒè¯æ•°æ®çš„æœ‰æ•ˆæ€§

## ğŸ“ æ€»ç»“

AINO è”è¡¨æ–¹æ¡ˆé€šè¿‡ç»Ÿä¸€çš„å…³è”è¡¨è®¾è®¡ï¼Œå®ç°äº†çµæ´»ã€é«˜æ•ˆçš„è®°å½•é—´å…³è”å…³ç³»ç®¡ç†ã€‚è¯¥æ–¹æ¡ˆå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **ç»Ÿä¸€æ€§**ï¼šä½¿ç”¨å•ä¸€å…³è”è¡¨ç®¡ç†æ‰€æœ‰å…³è”å…³ç³»ï¼Œç®€åŒ–äº†ç³»ç»Ÿæ¶æ„
2. **çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§å…³è”ç±»å‹å’ŒåŒå‘å…³è”ï¼Œæ»¡è¶³å¤æ‚ä¸šåŠ¡åœºæ™¯
3. **æ€§èƒ½**ï¼šé€šè¿‡å¤åˆç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–ï¼Œä¿è¯äº†è‰¯å¥½çš„æŸ¥è¯¢æ€§èƒ½
4. **ä¸€è‡´æ€§**ï¼šé€šè¿‡äº‹åŠ¡å¤„ç†å’Œé”™è¯¯å¤„ç†ï¼Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§
5. **æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥æ‰©å±•æ›´å¤šå…³è”ç±»å‹å’ŒåŠŸèƒ½

è¯¥æ–¹æ¡ˆä¸º AINO å¹³å°æä¾›äº†å¼ºå¤§çš„æ•°æ®å…³è”èƒ½åŠ›ï¼Œèƒ½å¤Ÿæ»¡è¶³å„ç§å¤æ‚çš„ä¸šåŠ¡åœºæ™¯éœ€æ±‚ã€‚

## ğŸ“Š å®ç°çŠ¶æ€

### âœ… å·²å®ŒæˆåŠŸèƒ½

#### 1. æ•°æ®åº“è®¾è®¡
- âœ… **å…³è”è¡¨ç»“æ„**ï¼š`relation_records` è¡¨å·²åˆ›å»ºå¹¶éƒ¨ç½²
- âœ… **å¤–é”®çº¦æŸ**ï¼šåº”ç”¨ã€ç›®å½•çš„å¤–é”®çº¦æŸå·²é…ç½®
- âœ… **ç´¢å¼•è®¾è®¡**ï¼šå¤åˆç´¢å¼•å·²åˆ›å»ºï¼Œæ”¯æŒé«˜æ•ˆæŸ¥è¯¢
- âœ… **å”¯ä¸€çº¦æŸ**ï¼šé˜²æ­¢é‡å¤å…³è”å…³ç³»çš„å”¯ä¸€çº¦æŸå·²è®¾ç½®

#### 2. åç«¯æœåŠ¡
- âœ… **å…³è”å…³ç³»ä»“åº“**ï¼š`RelationRecordsRepository` åŸºç¡€CRUDæ“ä½œ
- âœ… **å…³è”å…³ç³»æœåŠ¡**ï¼š`RelationRecordsService` ä¸šåŠ¡é€»è¾‘å¤„ç†
- âœ… **å…³è”åŒæ­¥æœåŠ¡**ï¼š`RelationSyncService` å­—æ®µå€¼å˜æ›´æ—¶åŒæ­¥å…³è”å…³ç³»
- âœ… **APIè·¯ç”±**ï¼šåŸºç¡€çš„å…³è”å…³ç³»ç®¡ç†APIæ¥å£
- âœ… **åŒå‘å…³è”**ï¼šæ”¯æŒåŒå‘å…³è”å…³ç³»çš„åˆ›å»ºå’Œç®¡ç†

#### 3. å‰ç«¯ç»„ä»¶
- âœ… **å…³è”å­—æ®µé…ç½®**ï¼š`RelationConfig` ç»„ä»¶æ”¯æŒå…³è”å­—æ®µé…ç½®
- âœ… **å…³è”è¾“å…¥ç»„ä»¶**ï¼š`RelationInput` æ”¯æŒå…³è”å­—æ®µçš„è¾“å…¥å’Œé€‰æ‹©
- âœ… **å…³è”æ ‡ç­¾é¡µ**ï¼š`RelationOneTab` æ”¯æŒä¸€å¯¹ä¸€å…³è”çš„æ˜¾ç¤º

### ğŸš§ éƒ¨åˆ†å®ŒæˆåŠŸèƒ½

#### 1. å…³è”è®°å½•æŸ¥è¯¢
- ğŸš§ **è®°å½•æ•°æ®æŸ¥è¯¢**ï¼šåŸºç¡€æ¡†æ¶å·²å®ç°ï¼Œä½†å®é™…è®°å½•æ•°æ®æŸ¥è¯¢éœ€è¦å®Œå–„
- ğŸš§ **ç›®å½•åç§°æŸ¥è¯¢**ï¼šéœ€è¦ä» `directoryDefs` è¡¨æŸ¥è¯¢ç›®å½•åç§°
- ğŸš§ **åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**ï¼šåŸºç¡€åˆ†é¡µå·²å®ç°ï¼Œæ€§èƒ½ä¼˜åŒ–å¾…å®Œå–„

#### 2. ç”¨æˆ·ä¸Šä¸‹æ–‡
- ğŸš§ **ç”¨æˆ·IDè·å–**ï¼šåˆ›å»ºå…³è”å…³ç³»æ—¶ç”¨æˆ·IDè·å–éœ€è¦å®Œå–„
- ğŸš§ **æƒé™æ§åˆ¶**ï¼šå…³è”å…³ç³»çš„æƒé™æ§åˆ¶éœ€è¦å®Œå–„

### âŒ æœªå®ŒæˆåŠŸèƒ½

#### 1. é«˜çº§æŸ¥è¯¢åŠŸèƒ½
- âŒ **å¤æ‚å…³è”æŸ¥è¯¢**ï¼šå¤šå±‚çº§å…³è”æŸ¥è¯¢
- âŒ **å…³è”ç»Ÿè®¡**ï¼šå…³è”å…³ç³»çš„ç»Ÿè®¡åˆ†æ
- âŒ **å…³è”æœç´¢**ï¼šåŸºäºå…³è”å…³ç³»çš„æœç´¢åŠŸèƒ½

#### 2. æ€§èƒ½ä¼˜åŒ–
- âŒ **ç¼“å­˜æœºåˆ¶**ï¼šå…³è”å…³ç³»æŸ¥è¯¢ç»“æœç¼“å­˜
- âŒ **æ‰¹é‡æ“ä½œä¼˜åŒ–**ï¼šå¤§é‡å…³è”å…³ç³»çš„æ‰¹é‡å¤„ç†ä¼˜åŒ–
- âŒ **æŸ¥è¯¢æ€§èƒ½ç›‘æ§**ï¼šå…³è”æŸ¥è¯¢çš„æ€§èƒ½ç›‘æ§å’Œåˆ†æ

#### 3. æ•°æ®ä¸€è‡´æ€§
- âŒ **äº‹åŠ¡å¤„ç†**ï¼šæ‰¹é‡æ“ä½œçš„äº‹åŠ¡å¤„ç†éœ€è¦å®Œå–„
- âŒ **æ•°æ®éªŒè¯**ï¼šå…³è”å…³ç³»åˆ›å»ºå‰çš„æ•°æ®æœ‰æ•ˆæ€§éªŒè¯
- âŒ **é”™è¯¯æ¢å¤**ï¼šå…³è”å…³ç³»åŒæ­¥å¤±è´¥æ—¶çš„é”™è¯¯æ¢å¤æœºåˆ¶

#### 4. ç®¡ç†åŠŸèƒ½
- âŒ **å…³è”å…³ç³»ç®¡ç†ç•Œé¢**ï¼šå¯è§†åŒ–çš„å…³è”å…³ç³»ç®¡ç†ç•Œé¢
- âŒ **å…³è”å…³ç³»å¯¼å…¥å¯¼å‡º**ï¼šæ‰¹é‡å¯¼å…¥å¯¼å‡ºå…³è”å…³ç³»
- âŒ **å…³è”å…³ç³»å®¡è®¡**ï¼šå…³è”å…³ç³»çš„å˜æ›´å®¡è®¡æ—¥å¿—

## ğŸ”§ å¾…å®Œå–„çš„å…·ä½“å®ç°

### 1. è®°å½•æ•°æ®æŸ¥è¯¢å®Œå–„

```typescript
// å½“å‰å®ç°ï¼ˆéœ€è¦å®Œå–„ï¼‰
async findRelatedRecords(...): Promise<RelatedRecordsListResponse> {
  // TODO: è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„è®°å½•è¡¨ç»“æ„æ¥æŸ¥è¯¢è®°å½•æ•°æ®
  // ç›®å‰è¿”å›åŸºæœ¬ç»“æ„ï¼Œå®é™…å®ç°æ—¶éœ€è¦æ ¹æ®directoryIdæŸ¥è¯¢å¯¹åº”çš„è®°å½•è¡¨
  const records = paginatedRelations.map(rel => ({
    id: rel.toRecordId,
    directoryId: rel.toDirectoryId,
    directoryName: '', // TODO: ä»directoryDefsæŸ¥è¯¢
    data: {}, // TODO: ä»å¯¹åº”çš„è®°å½•è¡¨æŸ¥è¯¢
    relationType: rel.relationType,
    createdAt: rel.createdAt.toISOString(),
  }))
}
```

**éœ€è¦å®Œå–„**ï¼š
- æ ¹æ® `directoryId` åŠ¨æ€æŸ¥è¯¢å¯¹åº”çš„è®°å½•è¡¨
- ä» `directoryDefs` è¡¨æŸ¥è¯¢ç›®å½•åç§°
- å®ç°è®°å½•æ•°æ®çš„å®Œæ•´æŸ¥è¯¢

### 2. ç”¨æˆ·ä¸Šä¸‹æ–‡å®Œå–„

```typescript
// å½“å‰å®ç°ï¼ˆéœ€è¦å®Œå–„ï¼‰
const [relation] = await db.insert(relationRecords).values({
  // ...
  createdBy: null, // TODO: ä»ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·ID
}).returning()
```

**éœ€è¦å®Œå–„**ï¼š
- ä»è¯·æ±‚ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·ID
- å®ç°ç”¨æˆ·æƒé™éªŒè¯
- æ·»åŠ ç”¨æˆ·æ“ä½œå®¡è®¡

### 3. äº‹åŠ¡å¤„ç†å®Œå–„

```typescript
// éœ€è¦æ·»åŠ äº‹åŠ¡å¤„ç†
async batchCreateRelations(data: BatchCreateRelationRequest): Promise<RelationResponse[]> {
  return await db.transaction(async (tx) => {
    // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ‰¹é‡åˆ›å»ºæ“ä½œ
    // ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
  });
}
```

## ğŸ“‹ ä¸‹ä¸€æ­¥å¼€å‘è®¡åˆ’

### é˜¶æ®µ1ï¼šæ ¸å¿ƒåŠŸèƒ½å®Œå–„ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰
1. **å®Œå–„è®°å½•æ•°æ®æŸ¥è¯¢**ï¼šå®ç°åŠ¨æ€è®°å½•è¡¨æŸ¥è¯¢
2. **å®Œå–„ç”¨æˆ·ä¸Šä¸‹æ–‡**ï¼šå®ç°ç”¨æˆ·IDè·å–å’Œæƒé™æ§åˆ¶
3. **å®Œå–„äº‹åŠ¡å¤„ç†**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### é˜¶æ®µ2ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰
1. **å®ç°ç¼“å­˜æœºåˆ¶**ï¼šå…³è”å…³ç³»æŸ¥è¯¢ç»“æœç¼“å­˜
2. **ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½**ï¼šå¤æ‚å…³è”æŸ¥è¯¢ä¼˜åŒ–
3. **æ·»åŠ æ€§èƒ½ç›‘æ§**ï¼šæŸ¥è¯¢æ€§èƒ½ç›‘æ§å’Œåˆ†æ

### é˜¶æ®µ3ï¼šç®¡ç†åŠŸèƒ½ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰
1. **å…³è”å…³ç³»ç®¡ç†ç•Œé¢**ï¼šå¯è§†åŒ–ç®¡ç†ç•Œé¢
2. **æ‰¹é‡æ“ä½œåŠŸèƒ½**ï¼šå¯¼å…¥å¯¼å‡ºåŠŸèƒ½
3. **å®¡è®¡æ—¥å¿—**ï¼šæ“ä½œå®¡è®¡å’Œæ—¥å¿—è®°å½•

## ğŸ¯ æ€»ç»“

AINO è”è¡¨æ–¹æ¡ˆçš„æ ¸å¿ƒæ¶æ„å’ŒåŸºç¡€åŠŸèƒ½å·²ç»å®ç°ï¼ŒåŒ…æ‹¬ï¼š

- âœ… **å®Œæ•´çš„æ•°æ®åº“è®¾è®¡**ï¼šè¡¨ç»“æ„ã€ç´¢å¼•ã€çº¦æŸéƒ½å·²å°±ä½
- âœ… **åŸºç¡€æœåŠ¡å±‚**ï¼šä»“åº“ã€æœåŠ¡ã€åŒæ­¥æœºåˆ¶éƒ½å·²å®ç°
- âœ… **å‰ç«¯ç»„ä»¶**ï¼šå…³è”å­—æ®µçš„é…ç½®å’Œè¾“å…¥ç»„ä»¶å·²å¯ç”¨
- âœ… **APIæ¥å£**ï¼šåŸºç¡€çš„å…³è”å…³ç³»ç®¡ç†APIå·²å®ç°

**å½“å‰çŠ¶æ€**ï¼šå¯ä»¥æ”¯æŒåŸºæœ¬çš„å…³è”å…³ç³»åˆ›å»ºã€æŸ¥è¯¢å’Œç®¡ç†ï¼Œä½†éœ€è¦å®Œå–„è®°å½•æ•°æ®æŸ¥è¯¢ã€ç”¨æˆ·ä¸Šä¸‹æ–‡å’Œäº‹åŠ¡å¤„ç†ç­‰æ ¸å¿ƒåŠŸèƒ½æ‰èƒ½è¾¾åˆ°ç”Ÿäº§å°±ç»ªçŠ¶æ€ã€‚

**å»ºè®®**ï¼šä¼˜å…ˆå®Œå–„é˜¶æ®µ1çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç¡®ä¿åŸºç¡€åŠŸèƒ½ç¨³å®šå¯é ï¼Œç„¶åå†è€ƒè™‘æ€§èƒ½ä¼˜åŒ–å’Œç®¡ç†åŠŸèƒ½çš„å¼€å‘ã€‚

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

### ğŸ“‹ ä¼˜åŒ–åŸåˆ™

**æ ¸å¿ƒåŸåˆ™**ï¼šä¿æŒç°æœ‰å…³è”è¡¨ç»“æ„ä¸å˜ï¼Œåªåš"è¾¹ä¸Šå¢å¼º"
- âœ… **ä¿æŒä¸åŠ¨**ï¼šç°æœ‰ `relation_records` è¡¨ç»“æ„å’Œå­—æ®µè®¾è®¡
- ğŸ”§ **è¡¥å……å¢å¼º**ï¼šç´¢å¼•ä¼˜åŒ–ã€æŸ¥è¯¢è§„èŒƒã€åªè¯»è§†å›¾ã€å¹‚ç­‰çº¦æŸ

### ğŸ—ï¸ ç°æœ‰è®¾è®¡ä¿æŒä¸å˜

#### âœ… ç»Ÿä¸€å…³è”è¡¨è®¾è®¡ï¼ˆä¿æŒä¸åŠ¨ï¼‰

```sql
-- ä¿æŒç°æœ‰è¡¨ç»“æ„ä¸å˜
CREATE TABLE "relation_records" (
    "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
    "application_id" uuid NOT NULL,  -- å¯¹åº” tenant_id æ¦‚å¿µ
    "from_directory_id" uuid NOT NULL,
    "from_record_id" uuid NOT NULL,
    "from_field_key" text NOT NULL,
    "to_directory_id" uuid NOT NULL,
    "to_record_id" uuid NOT NULL,
    "to_field_key" text,
    "relation_type" text NOT NULL,
    "bidirectional" boolean DEFAULT false,
    "created_at" timestamp with time zone DEFAULT now(),
    "updated_at" timestamp with time zone DEFAULT now(),
    "created_by" uuid
);
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- æœ€é€šç”¨çš„"è¾¹è¡¨ï¼ˆedge tableï¼‰"è®¾è®¡
- æœ€é€‚åˆ"æ¨¡å—åŒ– + JSONB åŠ¨æ€å­—æ®µ"çš„æ¶æ„
- æ”¯æŒå¤æ‚çš„è®°å½•é—´å…³è”å…³ç³»
- å®Œå…¨ç¬¦åˆæç®€å¯æ‰©å±•ç†å¿µ

### ğŸ”§ æ€§èƒ½ä¼˜åŒ–å¢å¼ºæ–¹æ¡ˆ

#### 1. å…³é”®ç´¢å¼•ä¼˜åŒ–ï¼ˆæ–°å¢ï¼‰

##### 1.1 å‡ºè¾¹æŸ¥è¯¢ç´¢å¼•ï¼ˆä»æŸè®°å½•æ‰¾å…³è”ï¼‰
```sql
-- å‡ºè¾¹ç´¢å¼•ï¼šä»æŸè®°å½•æ‰¾åˆ°æ‰€æœ‰å…³è”è®°å½•
CREATE INDEX IF NOT EXISTS idx_rel_out
ON relation_records (
  application_id, from_directory_id, from_record_id, relation_type, to_directory_id
);
```

##### 1.2 å…¥è¾¹æŸ¥è¯¢ç´¢å¼•ï¼ˆåå‘å¼•ç”¨ï¼‰
```sql
-- å…¥è¾¹ç´¢å¼•ï¼šæ‰¾å…³è”åˆ°æŸè®°å½•çš„"åå‘å¼•ç”¨"
CREATE INDEX IF NOT EXISTS idx_rel_in
ON relation_records (
  application_id, to_directory_id, to_record_id, relation_type, from_directory_id
);
```

##### 1.3 å­—æ®µçº§æŸ¥è¯¢ç´¢å¼•
```sql
-- åŒä¸€å­—æ®µçš„å»é‡/å¿«é€Ÿå­˜åœ¨æ€§æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_rel_from_field
ON relation_records (application_id, from_directory_id, from_field_key, from_record_id);

CREATE INDEX IF NOT EXISTS idx_rel_to_field
ON relation_records (application_id, to_directory_id, to_field_key, to_record_id);
```

##### 1.4 å¹‚ç­‰å†™å…¥ç´¢å¼•
```sql
-- å¹‚ç­‰å†™å…¥/é˜²é‡å¤ï¼ˆæ”¯æŒ ON CONFLICT DO NOTHINGï¼‰
CREATE INDEX IF NOT EXISTS idx_rel_idempotent
ON relation_records (
  application_id, from_directory_id, from_record_id,
  to_directory_id, to_record_id, relation_type
);
```

#### 2. æ ‡å‡†åŒ–æŸ¥è¯¢æ¨¡æ¿

##### 2.1 å‡ºè¾¹æŸ¥è¯¢æ¨¡æ¿ï¼ˆä» A è®°å½•æ‰¾åˆ°æ‰€æœ‰ Bï¼‰
```sql
-- æ ‡å‡†å‡ºè¾¹æŸ¥è¯¢
SELECT rr.*
FROM relation_records rr
WHERE rr.application_id = $1
  AND rr.from_directory_id = $2
  AND rr.from_record_id = $3
  -- å¯é€‰è¿‡æ»¤
  AND rr.relation_type = 'one_to_many'
  AND rr.to_directory_id = $4
ORDER BY rr.created_at DESC
LIMIT $limit OFFSET $offset;
```

##### 2.2 å…¥è¾¹æŸ¥è¯¢æ¨¡æ¿ï¼ˆåå‘å…³è”ï¼‰
```sql
-- æ ‡å‡†å…¥è¾¹æŸ¥è¯¢
SELECT rr.*
FROM relation_records rr
WHERE rr.application_id = $1
  AND rr.to_directory_id = $2
  AND rr.to_record_id = $3;
```

##### 2.3 çº§è”è®¡æ•°æŸ¥è¯¢ï¼ˆåˆ—è¡¨é¡µå±•ç¤º"å…³è”æ•°"ï¼‰
```sql
-- çº§è”è®¡æ•°æŸ¥è¯¢
SELECT to_directory_id, count(*) AS cnt
FROM relation_records
WHERE application_id = $1 
  AND from_directory_id = $2 
  AND from_record_id = $3
GROUP BY to_directory_id;
```

##### 2.4 JSONB å¤–é”®å­—æ®µè”æŸ¥
```sql
-- è¡¨è¾¾å¼ç´¢å¼•ï¼ˆä¸º JSONB å¤–é”®å­—æ®µï¼‰
CREATE INDEX IF NOT EXISTS idx_dir_users_manager_id
ON dir_users ((props->>'managerId'));

-- è”æŸ¥æŸ¥è¯¢
SELECT a.id, a.props, b.id, b.props
FROM dir_users a
JOIN dir_managers b
  ON (a.props->>'managerId') = (b.id::text)
WHERE a.application_id = $1;
```

##### 2.5 JSONB æ•°ç»„å¤šé€‰å¼•ç”¨
```sql
-- æ•°ç»„å­—æ®µ GIN ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_dir_users_skill_ids_gin
ON dir_users USING GIN ((props->'skillIds'));

-- æ•°ç»„è”æŸ¥æŸ¥è¯¢
SELECT *
FROM dir_users a
JOIN dir_skills b ON (b.id::text = ANY(SELECT jsonb_array_elements_text(a.props->'skillIds')))
WHERE a.application_id = $1;
```

#### 3. åªè¯»è§†å›¾å’Œå‡½æ•°ï¼ˆæ–°å¢ï¼‰

##### 3.1 ç›¸é‚»èŠ‚ç‚¹è§†å›¾ï¼ˆæŒ‰ç›®å½•å°è£…ï¼‰
```sql
-- ç”¨æˆ·å…³è”è®¢å•è§†å›¾
CREATE OR REPLACE VIEW v_user_related_orders AS
SELECT rr.from_record_id AS user_id,
       rr.to_record_id AS order_id,
       rr.relation_type,
       rr.created_at
FROM relation_records rr
WHERE rr.from_directory_id = 'users'
  AND rr.to_directory_id = 'orders';

-- è®¢å•å…³è”ç”¨æˆ·è§†å›¾
CREATE OR REPLACE VIEW v_order_related_users AS
SELECT rr.from_record_id AS order_id,
       rr.to_record_id AS user_id,
       rr.relation_type,
       rr.created_at
FROM relation_records rr
WHERE rr.from_directory_id = 'orders'
  AND rr.to_directory_id = 'users';
```

##### 3.2 é€šç”¨é‚»å±…æŸ¥è¯¢å‡½æ•°
```sql
-- è·å–ä¸€ä¸ªè®°å½•çš„ N è·³é‚»å±…ï¼ˆè½»é‡ç‰ˆï¼‰
CREATE OR REPLACE FUNCTION get_neighbors(
  p_application_id uuid, 
  p_from_dir text, 
  p_from_id uuid, 
  p_to_dir text, 
  p_limit int
) RETURNS TABLE(to_id uuid, relation_type text, created_at timestamp) AS $$
  SELECT rr.to_record_id, rr.relation_type, rr.created_at
  FROM relation_records rr
  WHERE rr.application_id = p_application_id
    AND rr.from_directory_id = p_from_dir
    AND rr.from_record_id = p_from_id
    AND (p_to_dir IS NULL OR rr.to_directory_id = p_to_dir)
  ORDER BY rr.created_at DESC
  LIMIT COALESCE(p_limit, 100);
$$ LANGUAGE sql STABLE;
```

#### 4. ä¸€è‡´æ€§ä¸å»é‡ç­–ç•¥

##### 4.1 åº”ç”¨å±‚å¼ºçº¦æŸï¼ˆæ¨èï¼‰
```typescript
// å¹‚ç­‰å†™å…¥ç­–ç•¥
export class RelationService {
  async createRelation(data: CreateRelationRequest): Promise<void> {
    // å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨
    const exists = await this.repo.exists(data);
    if (exists) {
      return; // å¹‚ç­‰æ“ä½œ
    }
    
    // å•äº‹åŠ¡å†…å®Œæˆ
    await db.transaction(async (tx) => {
      await tx.insert(relationRecords).values(data);
    });
  }
}
```

##### 4.2 æ•°æ®åº“å±‚å”¯ä¸€çº¦æŸï¼ˆå¯é€‰ï¼‰
```sql
-- å¯é€‰ï¼šæ·»åŠ å”¯ä¸€çº¦æŸæ”¯æŒ ON CONFLICT DO NOTHING
ALTER TABLE relation_records
ADD CONSTRAINT uq_rel_edge UNIQUE
(application_id, from_directory_id, from_record_id, to_directory_id, to_record_id, relation_type) 
DEFERRABLE;

-- æ”¯æŒå¹‚ç­‰å†™å…¥
INSERT INTO relation_records (...) VALUES (...)
ON CONFLICT (application_id, from_directory_id, from_record_id, to_directory_id, to_record_id, relation_type) 
DO NOTHING;
```

#### 5. çº§è”åˆ é™¤ç­–ç•¥

##### 5.1 è½¯åˆ é™¤ä¼˜å…ˆç­–ç•¥
```typescript
// è½¯åˆ é™¤ï¼šåœ¨ä¸šåŠ¡è¡¨ç”¨ is_deleted æ§åˆ¶å¯è§æ€§
export class RecordService {
  async deleteRecord(recordId: string): Promise<void> {
    await db.transaction(async (tx) => {
      // 1. å…ˆæ ‡è®°ä¸»è®°å½•ä¸ºåˆ é™¤
      await tx.update(records)
        .set({ isDeleted: true, deletedAt: new Date() })
        .where(eq(records.id, recordId));
      
      // 2. æ¸…ç†å…³è”å…³ç³»
      await tx.delete(relationRecords)
        .where(
          or(
            and(eq(relationRecords.fromRecordId, recordId)),
            and(eq(relationRecords.toRecordId, recordId))
          )
        );
    });
  }
}
```

##### 5.2 ç‰©ç†åˆ é™¤ç­–ç•¥
```typescript
// ç‰©ç†åˆ é™¤ï¼šå…ˆåˆ å…³è”å…³ç³»ï¼Œå†åˆ ä¸»è®°å½•
export class RecordService {
  async hardDeleteRecord(recordId: string): Promise<void> {
    await db.transaction(async (tx) => {
      // 1. å…ˆåˆ é™¤æ‰€æœ‰å…³è”å…³ç³»
      await tx.delete(relationRecords)
        .where(
          or(
            and(eq(relationRecords.fromRecordId, recordId)),
            and(eq(relationRecords.toRecordId, recordId))
          )
        );
      
      // 2. å†åˆ é™¤ä¸»è®°å½•
      await tx.delete(records)
        .where(eq(records.id, recordId));
    });
  }
}
```

#### 6. ç»Ÿè®¡ä¸æ‰§è¡Œè®¡åˆ’ä¼˜åŒ–

##### 6.1 æ‰©å±•ç»Ÿè®¡ä¿¡æ¯
```sql
-- ä¸ºè¡¨è¾¾å¼åˆ—å»ºç«‹æ‰©å±•ç»Ÿè®¡
CREATE STATISTICS stat_users_status_app 
ON (application_id), ((props->>'status')) 
FROM dir_users;

-- å®šæœŸæ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE relation_records;
ANALYZE dir_users;
```

##### 6.2 æ€§èƒ½ç›‘æ§
```sql
-- å¼€å¯ pg_stat_statements ç›‘æ§
-- å¯¹ä»¥ä¸‹æŸ¥è¯¢æ¨¡å¼è¿›è¡Œå‹æµ‹ï¼š
-- 1. å‡ºè¾¹æŸ¥è¯¢
-- 2. å…¥è¾¹æŸ¥è¯¢  
-- 3. å»é‡å­˜åœ¨æ€§æŸ¥è¯¢
-- 4. è®¡æ•°æŸ¥è¯¢
-- 5. æŒ‰æ—¶é—´åˆ†é¡µæŸ¥è¯¢

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
WHERE query LIKE '%relation_records%'
ORDER BY mean_time DESC;
```

#### 7. JSONB ä¸»è¡¨è”è¡¨æœ€ä½³å®è·µ

##### 7.1 ç»Ÿä¸€é”®åè§„èŒƒ
```typescript
// JSONB å¼•ç”¨é”®å‘½åè§„èŒƒ
interface UserRecord {
  props: {
    managerId: string;        // å•å€¼å¼•ç”¨
    skillIds: string[];       // æ•°ç»„å¼•ç”¨
    departmentId: string;     // éƒ¨é—¨å¼•ç”¨
    projectIds: string[];     // é¡¹ç›®æ•°ç»„å¼•ç”¨
  }
}
```

##### 7.2 å›ºå®šæŸ¥è¯¢å†™æ³•
```sql
-- æ ‡å‡†è”æŸ¥å†™æ³•
SELECT a.id, a.props, b.id, b.props
FROM dir_users a
JOIN dir_managers b
  ON (a.props->>'managerId') = (b.id::text)
WHERE a.application_id = $1;

-- é¿å… CASTï¼Œä¿è¯è¡¨è¾¾å¼ç´¢å¼•å¯ç”¨
-- æ­£ç¡®ï¼š(props->>'xxxId') = (target.id::text)
-- é”™è¯¯ï¼š(props->>'xxxId')::uuid = target.id
```

##### 7.3 ä¸¤æ®µå¼æŸ¥è¯¢ä¼˜åŒ–
```typescript
// é¿å…ä¸€æ¬¡æ€§"å…¨æ‹‰"è·¨å¤šä¸ª dir_* çš„ join
export class RelationService {
  async getRelatedRecordsWithDetails(
    applicationId: string,
    directoryId: string,
    recordId: string
  ): Promise<RelatedRecord[]> {
    // ç¬¬ä¸€æ®µï¼šå…ˆæ‹¿ ID é›†
    const relationIds = await this.getRelatedRecordIds(
      applicationId, directoryId, recordId
    );
    
    // ç¬¬äºŒæ®µï¼šåˆ†æ‰¹æŸ¥è¯¦æƒ…ï¼ˆé…åˆç¼“å­˜ï¼‰
    const records = await this.batchGetRecordsByIds(relationIds);
    
    return records;
  }
}
```

### ğŸ“‹ æœ€å°äº¤ä»˜æ¸…å•

#### ç«‹å³å¯å®æ–½çš„ä¼˜åŒ–ï¼ˆä»Šå¤©å°±èƒ½ä¸Šï¼‰

1. **å»º 4 ç»„å…³é”®ç´¢å¼•**ï¼š
   - `idx_rel_out`ï¼šå‡ºè¾¹æŸ¥è¯¢ç´¢å¼•
   - `idx_rel_in`ï¼šå…¥è¾¹æŸ¥è¯¢ç´¢å¼•
   - `idx_rel_from_field`ï¼šå­—æ®µçº§æŸ¥è¯¢ç´¢å¼•
   - `idx_rel_idempotent`ï¼šå¹‚ç­‰å†™å…¥ç´¢å¼•

2. **æ ‡å‡†åŒ–æŸ¥è¯¢æ¨¡æ¿**ï¼š
   - å‡ºè¾¹æŸ¥è¯¢æ¨¡æ¿
   - å…¥è¾¹æŸ¥è¯¢æ¨¡æ¿
   - çº§è”è®¡æ•°æŸ¥è¯¢æ¨¡æ¿

3. **ä¸ºé«˜é¢‘ç›®å½•è¡¥åªè¯»è§†å›¾**ï¼š
   - ç”¨æˆ·å…³è”è®¢å•è§†å›¾
   - è®¢å•å…³è”ç”¨æˆ·è§†å›¾
   - é€šç”¨é‚»å±…æŸ¥è¯¢å‡½æ•°

4. **å¼€å¯æ€§èƒ½ç›‘æ§**ï¼š
   - æ£€æŸ¥ `pg_stat_statements`
   - ä¾‹è¡Œ `ANALYZE` æ“ä½œ

5. **ï¼ˆå¯é€‰ï¼‰åŠ å”¯ä¸€çº¦æŸ**ï¼š
   - `uq_rel_edge` å”¯ä¸€çº¦æŸ
   - è§£é” `ON CONFLICT DO NOTHING` å¹‚ç­‰å†™

### ğŸ¯ ä¼˜åŒ–æ•ˆæœé¢„æœŸ

#### æ€§èƒ½æå‡
- **æŸ¥è¯¢æ€§èƒ½**ï¼šå‡ºè¾¹/å…¥è¾¹æŸ¥è¯¢æ€§èƒ½æå‡ 5-10 å€
- **ç´¢å¼•å‘½ä¸­ç‡**ï¼š90% ä»¥ä¸Šçš„æŸ¥è¯¢èƒ½å‘½ä¸­è¦†ç›–ç´¢å¼•
- **å¹¶å‘æ€§èƒ½**ï¼šæ”¯æŒæ›´é«˜çš„å¹¶å‘å†™å…¥å’ŒæŸ¥è¯¢

#### ç¨³å®šæ€§æå‡
- **å¹‚ç­‰å†™å…¥**ï¼šæ”¯æŒé‡å¤æ“ä½œä¸äº§ç”Ÿå‰¯ä½œç”¨
- **äº‹åŠ¡å®‰å…¨**ï¼šæ‰€æœ‰å…³è”æ“ä½œåœ¨äº‹åŠ¡ä¸­å®Œæˆ
- **æ•°æ®ä¸€è‡´æ€§**ï¼šé€šè¿‡å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤å…³è”

#### ç»´æŠ¤æ€§æå‡
- **æ ‡å‡†åŒ–æŸ¥è¯¢**ï¼šç»Ÿä¸€çš„æŸ¥è¯¢æ¨¡æ¿ï¼Œä¾¿äºç»´æŠ¤
- **åªè¯»è§†å›¾**ï¼šä¸ºå‰ç«¯/BI/AI æä¾›å‹å¥½çš„æŸ¥è¯¢æ¥å£
- **æ€§èƒ½ç›‘æ§**ï¼šå®Œå–„çš„æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–æœºåˆ¶

### ğŸš€ æ€»ç»“

**ä½ çš„è”è¡¨æ–¹æ¡ˆæ–¹å‘å®Œå…¨æ­£ç¡®**ï¼šä¿æŒ"ç»Ÿä¸€å…³è”è¡¨ + JSONB åŠ¨æ€å­—æ®µ"çš„æç®€å†…æ ¸ä¸åŠ¨ã€‚

**åªéœ€è¦è¡¥ä¸Š**ï¼š
1. é’ˆå¯¹æŸ¥è¯¢è·¯å¾„çš„ç´¢å¼•ä¼˜åŒ–
2. æ ‡å‡†åŒ–çš„æŸ¥è¯¢æ¨¡æ¿
3. å°‘é‡åªè¯»è§†å›¾/å‡½æ•°
4. å¹‚ç­‰/å»é‡ç­–ç•¥

**å°±èƒ½æŠŠç¨³å®šæ€§ä¸æ€§èƒ½æ‹‰æ»¡**ï¼Œè€Œä¸”å®Œå…¨ä¸ä¼šç ´åç°æœ‰å®ç°ã€‚

è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆå®Œå…¨éµå¾ª"ä¿æŒç°æœ‰æ¶æ„ä¸å˜"çš„åŸåˆ™ï¼Œæ‰€æœ‰å¢å¼ºéƒ½æ˜¯"è¾¹ä¸Šè¡¥å……"ï¼Œéšæ—¶å¯ä»¥å›æ»šï¼Œä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½ã€‚
