# AINO è”è¡¨æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† AINO å¹³å°çš„è”è¡¨æ–¹æ¡ˆè®¾è®¡ï¼Œè¯¥æ–¹æ¡ˆåŸºäºå…³ç³»å‹æ•°æ®åº“çš„å…³è”è¡¨æ¨¡å¼ï¼Œæ”¯æŒå¤æ‚çš„è®°å½•é—´å…³è”å…³ç³»ï¼Œä¸ºå¹³å°æä¾›çµæ´»çš„æ•°æ®å…³è”èƒ½åŠ›ã€‚

### âœ… æ ¸å¿ƒç‰¹æ€§

#### 1. ç»Ÿä¸€å…³è”è¡¨è®¾è®¡
- **å•ä¸€å…³è”è¡¨**ï¼šä½¿ç”¨ `relation_records` è¡¨ç»Ÿä¸€ç®¡ç†æ‰€æœ‰è®°å½•é—´çš„å…³è”å…³ç³»
- **åŒå‘å…³è”æ”¯æŒ**ï¼šæ”¯æŒå•å‘å’ŒåŒå‘å…³è”å…³ç³»
- **å¤šç§å…³è”ç±»å‹**ï¼šæ”¯æŒä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šå…³è”
- **çº§è”åˆ é™¤**ï¼šæ”¯æŒå…³è”åˆ é™¤ç­–ç•¥ï¼ˆcascadeã€restrictã€set_nullï¼‰

#### 2. é«˜æ€§èƒ½æŸ¥è¯¢ä¼˜åŒ–
- **å¤åˆç´¢å¼•**ï¼šé’ˆå¯¹æŸ¥è¯¢åœºæ™¯ä¼˜åŒ–çš„å¤åˆç´¢å¼•è®¾è®¡
- **å”¯ä¸€çº¦æŸ**ï¼šé˜²æ­¢é‡å¤å…³è”å…³ç³»
- **åˆ†é¡µæŸ¥è¯¢**ï¼šæ”¯æŒå¤§é‡å…³è”æ•°æ®çš„åˆ†é¡µæŸ¥è¯¢

#### 3. æ•°æ®ä¸€è‡´æ€§ä¿éšœ
- **äº‹åŠ¡å¤„ç†**ï¼šå…³è”å…³ç³»çš„åˆ›å»ºå’Œåˆ é™¤åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
- **åŒæ­¥æœºåˆ¶**ï¼šå­—æ®µå€¼å˜æ›´æ—¶è‡ªåŠ¨åŒæ­¥å…³è”å…³ç³»
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶

## ğŸ—ï¸ æ•°æ®åº“è®¾è®¡

### å…³è”è¡¨ç»“æ„

```sql
-- å…³è”å…³ç³»è¡¨
CREATE TABLE "relation_records" (
    "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
    "application_id" uuid NOT NULL,
    "from_directory_id" uuid NOT NULL,
    "from_record_id" uuid NOT NULL,
    "from_field_key" text NOT NULL,
    "to_directory_id" uuid NOT NULL,
    "to_record_id" uuid NOT NULL,
    "to_field_key" text,
    "relation_type" text NOT NULL,
    "bidirectional" boolean DEFAULT false,
    "created_at" timestamp with time zone DEFAULT now(),
    "updated_at" timestamp with time zone DEFAULT now(),
    "created_by" uuid
);
```

### å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | uuid | ä¸»é”®ï¼Œè‡ªåŠ¨ç”Ÿæˆ |
| `application_id` | uuid | åº”ç”¨IDï¼Œå¤–é”®å…³è”åˆ°applicationsè¡¨ |
| `from_directory_id` | uuid | æºç›®å½•IDï¼Œå¤–é”®å…³è”åˆ°directory_defsè¡¨ |
| `from_record_id` | uuid | æºè®°å½•ID |
| `from_field_key` | text | æºå­—æ®µé”®å |
| `to_directory_id` | uuid | ç›®æ ‡ç›®å½•IDï¼Œå¤–é”®å…³è”åˆ°directory_defsè¡¨ |
| `to_record_id` | uuid | ç›®æ ‡è®°å½•ID |
| `to_field_key` | text | ç›®æ ‡å­—æ®µé”®åï¼ˆåŒå‘å…³è”æ—¶ä½¿ç”¨ï¼‰ |
| `relation_type` | text | å…³è”ç±»å‹ï¼š'one_to_one', 'one_to_many', 'many_to_many' |
| `bidirectional` | boolean | æ˜¯å¦ä¸ºåŒå‘å…³è” |
| `created_at` | timestamp | åˆ›å»ºæ—¶é—´ |
| `updated_at` | timestamp | æ›´æ–°æ—¶é—´ |
| `created_by` | uuid | åˆ›å»ºè€…ID |

### å¤–é”®çº¦æŸ

```sql
-- åº”ç”¨çº§è”åˆ é™¤
ALTER TABLE "relation_records" 
ADD CONSTRAINT "relation_records_application_id_applications_id_fk" 
FOREIGN KEY ("application_id") REFERENCES "applications"("id") 
ON DELETE cascade ON UPDATE no action;

-- æºç›®å½•çº§è”åˆ é™¤
ALTER TABLE "relation_records" 
ADD CONSTRAINT "relation_records_from_directory_id_directory_defs_id_fk" 
FOREIGN KEY ("from_directory_id") REFERENCES "directory_defs"("id") 
ON DELETE cascade ON UPDATE no action;

-- ç›®æ ‡ç›®å½•çº§è”åˆ é™¤
ALTER TABLE "relation_records" 
ADD CONSTRAINT "relation_records_to_directory_id_directory_defs_id_fk" 
FOREIGN KEY ("to_directory_id") REFERENCES "directory_defs"("id") 
ON DELETE cascade ON UPDATE no action;
```

### ç´¢å¼•è®¾è®¡

```sql
-- æ—¶é—´ç´¢å¼•
CREATE INDEX "relation_records_created_at_idx" ON "relation_records" ("created_at");

-- æºè®°å½•æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_from_idx" ON "relation_records" 
("from_directory_id", "from_record_id", "from_field_key");

-- ç›®æ ‡è®°å½•æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_to_idx" ON "relation_records" 
("to_directory_id", "to_record_id", "to_field_key");

-- åº”ç”¨æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_app_idx" ON "relation_records" ("application_id");

-- å”¯ä¸€çº¦æŸï¼ˆé˜²æ­¢é‡å¤å…³è”ï¼‰
ALTER TABLE "relation_records" 
ADD CONSTRAINT "relation_records_unique" 
UNIQUE("from_directory_id", "from_record_id", "from_field_key", "to_directory_id", "to_record_id");
```

## ğŸ”§ å…³è”ç±»å‹è®¾è®¡

### 1. ä¸€å¯¹ä¸€å…³è” (one_to_one)

```typescript
// å­—æ®µé…ç½®
{
  key: 'manager',
  kind: 'relation',
  type: 'relation_one',
  relation: {
    targetDirId: 'employees',
    mode: 'one',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'reports',
    onDelete: 'restrict'
  }
}
```

**ç‰¹ç‚¹**ï¼š
- æ¯ä¸ªæºè®°å½•æœ€å¤šå…³è”ä¸€ä¸ªç›®æ ‡è®°å½•
- æ”¯æŒåŒå‘å…³è”
- åˆ é™¤æ—¶æ ¹æ® `onDelete` ç­–ç•¥å¤„ç†

### 2. ä¸€å¯¹å¤šå…³è” (one_to_many)

```typescript
// å­—æ®µé…ç½®
{
  key: 'employees',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'employees',
    mode: 'many',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'department',
    onDelete: 'cascade'
  }
}
```

**ç‰¹ç‚¹**ï¼š
- æ¯ä¸ªæºè®°å½•å¯ä»¥å…³è”å¤šä¸ªç›®æ ‡è®°å½•
- æ”¯æŒåŒå‘å…³è”
- æ‰¹é‡åˆ›å»ºå’Œåˆ é™¤å…³è”å…³ç³»

### 3. å¤šå¯¹å¤šå…³è” (many_to_many)

```typescript
// å­—æ®µé…ç½®
{
  key: 'skills',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'skills',
    mode: 'many',
    displayFieldKey: 'name',
    bidirectional: false,
    onDelete: 'restrict'
  }
}
```

**ç‰¹ç‚¹**ï¼š
- å¤šä¸ªæºè®°å½•å¯ä»¥å…³è”å¤šä¸ªç›®æ ‡è®°å½•
- é€šè¿‡å…³è”è¡¨å®ç°å¤šå¯¹å¤šå…³ç³»
- æ”¯æŒå¤æ‚çš„å…³è”æŸ¥è¯¢

## ğŸš€ æ ¸å¿ƒæœåŠ¡è®¾è®¡

### 1. å…³è”å…³ç³»æœåŠ¡ (RelationRecordsService)

```typescript
export class RelationRecordsService {
  // åˆ›å»ºå…³è”å…³ç³»
  async createRelation(data: CreateRelationRequest): Promise<RelationResponse>
  
  // æ‰¹é‡åˆ›å»ºå…³è”å…³ç³»
  async batchCreateRelations(data: BatchCreateRelationRequest): Promise<RelationResponse[]>
  
  // åˆ é™¤å…³è”å…³ç³»
  async deleteRelation(data: DeleteRelationRequest): Promise<void>
  
  // åˆ é™¤å­—æ®µçš„æ‰€æœ‰å…³è”å…³ç³»
  async deleteFieldRelations(applicationId: string, directoryId: string, recordId: string, fieldKey: string): Promise<void>
  
  // åˆ é™¤è®°å½•çš„æ‰€æœ‰å…³è”å…³ç³»
  async deleteRecordRelations(applicationId: string, directoryId: string, recordId: string): Promise<void>
  
  // è·å–å…³è”å…³ç³»åˆ—è¡¨
  async getRelations(params: GetRelationsRequest): Promise<RelationsListResponse>
  
  // è·å–å…³è”çš„è®°å½•
  async getRelatedRecords(applicationId: string, directoryId: string, recordId: string, fieldKey: string, page?: number, limit?: number): Promise<RelatedRecordsListResponse>
  
  // åŒæ­¥å…³è”å…³ç³»ï¼ˆå­—æ®µå€¼å˜æ›´æ—¶è°ƒç”¨ï¼‰
  async syncRelations(applicationId: string, directoryId: string, recordId: string, fieldKey: string, newValue: any, fieldConfig: any): Promise<void>
}
```

### 2. å…³è”åŒæ­¥æœåŠ¡ (RelationSyncService)

```typescript
export class RelationSyncService {
  // åŒæ­¥å…³è”å­—æ®µçš„å…³è”å…³ç³»
  async syncRelationField(fieldDef: FieldDef, newValue: any, oldValue: any, context: RelationSyncContext): Promise<void>
  
  // æ‰¹é‡åŒæ­¥å…³è”å­—æ®µ
  async syncRelationFields(fieldDefs: FieldDef[], newRecord: Record<string, any>, oldRecord: Record<string, any>, context: RelationSyncContext): Promise<void>
  
  // åˆ é™¤è®°å½•æ—¶æ¸…ç†å…³è”å…³ç³»
  async cleanupRecordRelations(context: RelationSyncContext): Promise<void>
  
  // è·å–å…³è”çš„è®°å½•
  async getRelatedRecords(context: RelationSyncContext, fieldKey: string, page?: number, limit?: number): Promise<RelatedRecordsListResponse>
}
```

## ğŸ“Š æ•°æ®æµè½¬è®¾è®¡

### 1. åˆ›å»ºå…³è”å…³ç³»æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è®¾ç½®å…³è”å­—æ®µå€¼] --> B[å­—æ®µå¤„ç†å™¨åºåˆ—åŒ–]
    B --> C[ä¿å­˜è®°å½•åˆ°æ•°æ®åº“]
    C --> D[è§¦å‘å…³è”åŒæ­¥æœåŠ¡]
    D --> E[åˆ é™¤æ—§å…³è”å…³ç³»]
    E --> F[åˆ›å»ºæ–°å…³è”å…³ç³»]
    F --> G[æ›´æ–°å…³è”è¡¨]
    G --> H[è¿”å›æˆåŠŸå“åº”]
```

### 2. æŸ¥è¯¢å…³è”è®°å½•æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·æŸ¥è¯¢å…³è”è®°å½•] --> B[è°ƒç”¨å…³è”æœåŠ¡]
    B --> C[æ ¹æ®ç´¢å¼•æŸ¥è¯¢å…³è”è¡¨]
    C --> D[è·å–ç›®æ ‡è®°å½•IDåˆ—è¡¨]
    D --> E[æŸ¥è¯¢ç›®æ ‡è®°å½•è¯¦æƒ…]
    E --> F[ç»„è£…è¿”å›æ•°æ®]
    F --> G[è¿”å›åˆ†é¡µç»“æœ]
```

### 3. åˆ é™¤è®°å½•æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·åˆ é™¤è®°å½•] --> B[æ£€æŸ¥å…³è”å…³ç³»]
    B --> C{æ ¹æ®onDeleteç­–ç•¥}
    C -->|cascade| D[çº§è”åˆ é™¤å…³è”è®°å½•]
    C -->|restrict| E[æ£€æŸ¥æ˜¯å¦æœ‰å…³è”]
    C -->|set_null| F[è®¾ç½®å…³è”å­—æ®µä¸ºnull]
    E --> G{æ˜¯å¦æœ‰å…³è”}
    G -->|æ˜¯| H[æ‹’ç»åˆ é™¤]
    G -->|å¦| I[åˆ é™¤è®°å½•]
    D --> I
    F --> I
    I --> J[æ¸…ç†å…³è”å…³ç³»]
    J --> K[è¿”å›æˆåŠŸå“åº”]
```

## ğŸ” æŸ¥è¯¢ä¼˜åŒ–è®¾è®¡

### 1. ç´¢å¼•ç­–ç•¥

```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX "relation_records_from_idx" ON "relation_records" 
("from_directory_id", "from_record_id", "from_field_key");

CREATE INDEX "relation_records_to_idx" ON "relation_records" 
("to_directory_id", "to_record_id", "to_field_key");

-- åº”ç”¨çº§æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_app_idx" ON "relation_records" ("application_id");
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```typescript
// åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
async getRelatedRecords(
  applicationId: string,
  directoryId: string,
  recordId: string,
  fieldKey: string,
  page: number = 1,
  limit: number = 20
): Promise<RelatedRecordsListResponse> {
  const offset = (page - 1) * limit;
  
  // ä½¿ç”¨å¤åˆç´¢å¼•å¿«é€Ÿå®šä½å…³è”å…³ç³»
  const relations = await this.repo.findByFromRecord(
    applicationId, directoryId, recordId, fieldKey, limit, offset
  );
  
  // æ‰¹é‡æŸ¥è¯¢ç›®æ ‡è®°å½•
  const recordIds = relations.map(r => r.toRecordId);
  const records = await this.recordService.getRecordsByIds(recordIds);
  
  return {
    records: records.map(record => ({
      id: record.id,
      directoryId: record.directoryId,
      directoryName: record.directoryName,
      data: record.data,
      relationType: 'one_to_many',
      createdAt: record.createdAt
    })),
    total: relations.length,
    page,
    limit,
    totalPages: Math.ceil(relations.length / limit)
  };
}
```

## ğŸ›¡ï¸ æ•°æ®ä¸€è‡´æ€§ä¿éšœ

### 1. äº‹åŠ¡å¤„ç†

```typescript
// æ‰¹é‡åˆ›å»ºå…³è”å…³ç³»æ—¶ä½¿ç”¨äº‹åŠ¡
async batchCreateRelations(data: BatchCreateRelationRequest): Promise<RelationResponse[]> {
  return await db.transaction(async (tx) => {
    const relations = [];
    for (const relationData of data.relations) {
      const relation = await tx.insert(relationRecords).values({
        applicationId: data.applicationId,
        ...relationData,
        createdBy: null, // TODO: ä»ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·ID
      }).returning();
      relations.push(relation[0]);
    }
    return relations;
  });
}
```

### 2. é”™è¯¯å¤„ç†

```typescript
// å…³è”åŒæ­¥æ—¶çš„é”™è¯¯å¤„ç†
async syncRelationField(fieldDef: FieldDef, newValue: any, oldValue: any, context: RelationSyncContext) {
  try {
    // åˆ é™¤æ—§çš„å…³è”å…³ç³»
    await this.relationService.deleteFieldRelations(
      context.applicationId,
      context.directoryId,
      context.recordId,
      fieldDef.key
    );

    // åˆ›å»ºæ–°çš„å…³è”å…³ç³»
    if (newValue) {
      // ... åˆ›å»ºé€»è¾‘
    }
  } catch (error) {
    console.error('åŒæ­¥å…³è”å…³ç³»å¤±è´¥:', error);
    // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“ä¸»æµç¨‹
  }
}
```

### 3. æ•°æ®éªŒè¯

```typescript
// å…³è”å…³ç³»æ•°æ®éªŒè¯
export const CreateRelationRequest = z.object({
  applicationId: z.string().uuid(),
  fromDirectoryId: z.string().uuid(),
  fromRecordId: z.string().uuid(),
  fromFieldKey: z.string(),
  toDirectoryId: z.string().uuid(),
  toRecordId: z.string().uuid(),
  toFieldKey: z.string().optional(),
  relationType: RelationTypeEnum,
  bidirectional: z.boolean().default(false),
});
```

## ğŸ¯ ä¸šåŠ¡åœºæ™¯æ”¯æŒ

### 1. ç”¨æˆ·-éƒ¨é—¨å…³è”

```typescript
// ç”¨æˆ·è¡¨çš„éƒ¨é—¨å­—æ®µ
{
  key: 'department',
  kind: 'relation',
  type: 'relation_one',
  relation: {
    targetDirId: 'departments',
    mode: 'one',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'employees',
    onDelete: 'restrict'
  }
}

// éƒ¨é—¨è¡¨çš„å‘˜å·¥å­—æ®µ
{
  key: 'employees',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'employees',
    mode: 'many',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'department',
    onDelete: 'cascade'
  }
}
```

### 2. é¡¹ç›®-ä»»åŠ¡å…³è”

```typescript
// é¡¹ç›®è¡¨çš„ä»»åŠ¡å­—æ®µ
{
  key: 'tasks',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'tasks',
    mode: 'many',
    displayFieldKey: 'title',
    bidirectional: true,
    reverseFieldKey: 'project',
    onDelete: 'cascade'
  }
}

// ä»»åŠ¡è¡¨çš„é¡¹ç›®å­—æ®µ
{
  key: 'project',
  kind: 'relation',
  type: 'relation_one',
  relation: {
    targetDirId: 'projects',
    mode: 'one',
    displayFieldKey: 'name',
    bidirectional: true,
    reverseFieldKey: 'tasks',
    onDelete: 'restrict'
  }
}
```

### 3. ç”¨æˆ·-æŠ€èƒ½å…³è”

```typescript
// ç”¨æˆ·è¡¨çš„æŠ€èƒ½å­—æ®µ
{
  key: 'skills',
  kind: 'relation',
  type: 'relation_many',
  relation: {
    targetDirId: 'skills',
    mode: 'many',
    displayFieldKey: 'name',
    bidirectional: false,
    onDelete: 'restrict'
  }
}
```

## ğŸ”§ API æ¥å£è®¾è®¡

### 1. å…³è”å…³ç³»ç®¡ç†æ¥å£

```typescript
// åˆ›å»ºå…³è”å…³ç³»
POST /api/relations
{
  "applicationId": "uuid",
  "fromDirectoryId": "uuid",
  "fromRecordId": "uuid",
  "fromFieldKey": "string",
  "toDirectoryId": "uuid",
  "toRecordId": "uuid",
  "toFieldKey": "string",
  "relationType": "one_to_one" | "one_to_many" | "many_to_many",
  "bidirectional": boolean
}

// æ‰¹é‡åˆ›å»ºå…³è”å…³ç³»
POST /api/relations/batch
{
  "applicationId": "uuid",
  "relations": [...]
}

// åˆ é™¤å…³è”å…³ç³»
DELETE /api/relations
{
  "applicationId": "uuid",
  "fromDirectoryId": "uuid",
  "fromRecordId": "uuid",
  "fromFieldKey": "string",
  "toDirectoryId": "uuid",
  "toRecordId": "uuid"
}

// æŸ¥è¯¢å…³è”å…³ç³»
GET /api/relations?applicationId=uuid&directoryId=uuid&recordId=uuid&fieldKey=string&page=1&limit=20
```

### 2. å…³è”è®°å½•æŸ¥è¯¢æ¥å£

```typescript
// è·å–å…³è”çš„è®°å½•
GET /api/records/:directoryId/:recordId/relations/:fieldKey?page=1&limit=20

// å“åº”æ ¼å¼
{
  "success": true,
  "data": {
    "records": [
      {
        "id": "uuid",
        "directoryId": "uuid",
        "directoryName": "string",
        "data": {...},
        "relationType": "one_to_many",
        "createdAt": "2024-01-01T00:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "limit": 20,
    "totalPages": 5
  }
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ä¼˜åŒ–

```sql
-- æ ¹æ®æŸ¥è¯¢æ¨¡å¼æ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX "relation_records_from_field_idx" ON "relation_records" 
("from_directory_id", "from_field_key", "created_at");

-- åŒå‘å…³è”æŸ¥è¯¢ç´¢å¼•
CREATE INDEX "relation_records_bidirectional_idx" ON "relation_records" 
("to_directory_id", "to_field_key", "from_directory_id", "from_field_key");
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```typescript
// ä½¿ç”¨ EXISTS å­æŸ¥è¯¢ä¼˜åŒ–å…³è”æŸ¥è¯¢
async getRelatedRecordsOptimized(params: GetRelatedRecordsParams) {
  const query = db
    .select()
    .from(targetTable)
    .where(
      exists(
        db
          .select()
          .from(relationRecords)
          .where(
            and(
              eq(relationRecords.fromDirectoryId, params.directoryId),
              eq(relationRecords.fromRecordId, params.recordId),
              eq(relationRecords.fromFieldKey, params.fieldKey),
              eq(relationRecords.toDirectoryId, params.targetDirectoryId),
              eq(relationRecords.toRecordId, targetTable.id)
            )
          )
      )
    );
    
  return await query;
}
```

### 3. ç¼“å­˜ç­–ç•¥

```typescript
// å…³è”å…³ç³»ç¼“å­˜
class RelationCache {
  private cache = new Map<string, any>();
  
  async getRelatedRecords(key: string): Promise<any> {
    if (this.cache.has(key)) {
      return this.cache.get(key);
    }
    
    const data = await this.relationService.getRelatedRecords(key);
    this.cache.set(key, data);
    
    // è®¾ç½®è¿‡æœŸæ—¶é—´
    setTimeout(() => this.cache.delete(key), 5 * 60 * 1000); // 5åˆ†é’Ÿ
    
    return data;
  }
}
```

## ğŸš¨ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸€è‡´æ€§

- **äº‹åŠ¡å¤„ç†**ï¼šå…³è”å…³ç³»çš„åˆ›å»ºå’Œåˆ é™¤å¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œ
- **çº§è”åˆ é™¤**ï¼šåˆ é™¤è®°å½•æ—¶éœ€è¦æ ¹æ® `onDelete` ç­–ç•¥å¤„ç†å…³è”å…³ç³»
- **åŒå‘åŒæ­¥**ï¼šåŒå‘å…³è”æ—¶éœ€è¦åŒæ­¥æ›´æ–°ä¸¤ç«¯çš„å…³è”å…³ç³»

### 2. æ€§èƒ½è€ƒè™‘

- **ç´¢å¼•ä¼˜åŒ–**ï¼šæ ¹æ®æŸ¥è¯¢æ¨¡å¼è®¾è®¡åˆé€‚çš„å¤åˆç´¢å¼•
- **åˆ†é¡µæŸ¥è¯¢**ï¼šå¤§é‡å…³è”æ•°æ®å¿…é¡»ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢
- **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡åˆ›å»ºå…³è”å…³ç³»æ—¶ä½¿ç”¨äº‹åŠ¡å’Œæ‰¹é‡æ’å…¥

### 3. é”™è¯¯å¤„ç†

- **å¤–é”®çº¦æŸ**ï¼šåˆ é™¤ç›®å½•æˆ–è®°å½•æ—¶éœ€è¦å¤„ç†å¤–é”®çº¦æŸ
- **å”¯ä¸€çº¦æŸ**ï¼šé˜²æ­¢åˆ›å»ºé‡å¤çš„å…³è”å…³ç³»
- **æ•°æ®éªŒè¯**ï¼šåˆ›å»ºå…³è”å…³ç³»å‰éªŒè¯æ•°æ®çš„æœ‰æ•ˆæ€§

## ğŸ“ æ€»ç»“

AINO è”è¡¨æ–¹æ¡ˆé€šè¿‡ç»Ÿä¸€çš„å…³è”è¡¨è®¾è®¡ï¼Œå®ç°äº†çµæ´»ã€é«˜æ•ˆçš„è®°å½•é—´å…³è”å…³ç³»ç®¡ç†ã€‚è¯¥æ–¹æ¡ˆå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **ç»Ÿä¸€æ€§**ï¼šä½¿ç”¨å•ä¸€å…³è”è¡¨ç®¡ç†æ‰€æœ‰å…³è”å…³ç³»ï¼Œç®€åŒ–äº†ç³»ç»Ÿæ¶æ„
2. **çµæ´»æ€§**ï¼šæ”¯æŒå¤šç§å…³è”ç±»å‹å’ŒåŒå‘å…³è”ï¼Œæ»¡è¶³å¤æ‚ä¸šåŠ¡åœºæ™¯
3. **æ€§èƒ½**ï¼šé€šè¿‡å¤åˆç´¢å¼•å’ŒæŸ¥è¯¢ä¼˜åŒ–ï¼Œä¿è¯äº†è‰¯å¥½çš„æŸ¥è¯¢æ€§èƒ½
4. **ä¸€è‡´æ€§**ï¼šé€šè¿‡äº‹åŠ¡å¤„ç†å’Œé”™è¯¯å¤„ç†ï¼Œä¿è¯äº†æ•°æ®çš„ä¸€è‡´æ€§
5. **æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥æ‰©å±•æ›´å¤šå…³è”ç±»å‹å’ŒåŠŸèƒ½

è¯¥æ–¹æ¡ˆä¸º AINO å¹³å°æä¾›äº†å¼ºå¤§çš„æ•°æ®å…³è”èƒ½åŠ›ï¼Œèƒ½å¤Ÿæ»¡è¶³å„ç§å¤æ‚çš„ä¸šåŠ¡åœºæ™¯éœ€æ±‚ã€‚
