# AINO 用户体系设计文档

## 📋 概述

AINO 平台采用三层用户体系设计，实现平台管理、应用访问控制和业务功能权限的完全分离。

## 🏗️ 三层用户体系架构

### 架构图
```
AINO 平台
├── 平台级用户 (users)
│   ├── 平台管理员
│   ├── 应用开发者  
│   └── 系统操作员
├── 应用级权限 (application_members)
│   ├── 应用拥有者 (owner)
│   ├── 应用管理员 (admin)
│   └── 应用成员 (member)
└── 业务级用户 (application_users)
    ├── 应用业务用户 (ToC用户)
    ├── 角色权限管理
    └── 业务功能权限
```

## 📊 三种用户表详细说明

### 1. `users` 表 - 平台管理员用户

**用途**：登录AINO平台后台的用户

**字段结构**：
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password TEXT NOT NULL,
  roles TEXT[] DEFAULT ['user'], -- 平台角色
  avatar TEXT,
  status TEXT DEFAULT 'active',
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**用户类型**：
- **平台管理员**：管理整个AINO平台
- **应用开发者**：创建和管理应用
- **系统操作员**：维护平台功能

**使用场景**：
- 登录AINO-studio后台
- 创建和管理应用
- 系统配置和维护
- 用户权限管理

### 2. `application_members` 表 - 应用成员管理

**用途**：控制哪些平台用户可以访问特定应用

**字段结构**：
```sql
CREATE TABLE application_members (
  id UUID PRIMARY KEY,
  application_id UUID NOT NULL, -- 应用ID
  user_id UUID NOT NULL,        -- 平台用户ID
  role TEXT DEFAULT 'member',   -- owner, admin, member
  permissions JSONB DEFAULT '{}', -- 权限配置
  joined_at TIMESTAMP DEFAULT NOW(),
  invited_by UUID,              -- 邀请人
  status TEXT DEFAULT 'active'  -- active, inactive
);
```

**角色类型**：
- **owner**：应用拥有者，拥有所有权限
- **admin**：应用管理员，可以管理应用内容
- **member**：应用成员，可以访问应用

**使用场景**：
- 控制应用访问权限
- 团队协作管理
- 应用权限分配
- 成员邀请和移除

### 3. `application_users` 表 - 应用业务用户

**用途**：应用内的实际业务用户（ToC用户）

**字段结构**：
```sql
CREATE TABLE application_users (
  id UUID PRIMARY KEY,
  application_id UUID NOT NULL, -- 应用ID
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  avatar TEXT,
  status TEXT DEFAULT 'active', -- active, inactive, pending
  role TEXT DEFAULT 'user',     -- admin, user, guest
  department TEXT,
  position TEXT,
  tags TEXT[] DEFAULT '{}',
  metadata JSONB DEFAULT '{}',  -- 扩展字段
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**用户类型**：
- **应用管理员**：管理应用内的业务用户
- **普通用户**：使用应用功能
- **访客用户**：有限权限访问

**使用场景**：
- 用户注册和登录应用
- 个人资料管理
- 业务功能使用
- 应用内权限控制

## 🔐 权限层级设计

### 权限层级关系
```
平台级权限 (users)
    ↓
应用级权限 (application_members)
    ↓
业务级权限 (application_users)
```

### 权限控制逻辑
1. **平台级权限**：必须先有平台用户身份
2. **应用级权限**：平台用户必须被添加到应用成员中
3. **业务级权限**：在应用内进行业务操作时的权限控制

## 🎯 实际使用场景

### 场景1：电商应用
```
平台用户A（开发者）创建电商应用
├── 应用成员管理
│   ├── 用户A → owner（拥有者）
│   ├── 用户B → admin（运营管理员）
│   └── 用户C → member（客服人员）
└── 业务用户管理
    ├── 买家用户（使用购物功能）
    ├── 卖家用户（使用店铺管理）
    └── 客服用户（使用客服功能）
```

### 场景2：教育应用
```
平台用户B（老师）创建教育应用
├── 应用成员管理
│   ├── 用户B → owner（课程创建者）
│   ├── 用户D → admin（助教）
│   └── 用户E → member（技术支持）
└── 业务用户管理
    ├── 学生用户（学习课程）
    ├── 家长用户（查看学习进度）
    └── 老师用户（管理课程）
```

## ⚠️ 开发约束

### 1. 用户身份严格区分
- **绝不可混淆**三种用户类型的用途
- 开发时必须明确当前操作的是哪种用户类型
- API设计时要明确用户上下文

### 2. 权限检查顺序
1. 检查平台用户身份（users表）
2. 检查应用访问权限（application_members表）
3. 检查业务功能权限（application_users表）

### 3. 数据隔离原则
- 每个应用的用户数据完全隔离
- 通过application_id进行数据隔离
- 跨应用数据访问需要特殊权限

## 📋 开发检查清单

开发用户相关功能时，请确认：

- [ ] 明确当前操作的是哪种用户类型
- [ ] 正确使用对应的用户表
- [ ] 实现了正确的权限检查
- [ ] 数据隔离是否完整
- [ ] API响应格式是否一致
- [ ] 错误处理是否完善

## 🚀 未来扩展

### 计划中的功能
1. **单点登录（SSO）**：支持第三方身份认证
2. **多租户增强**：支持更复杂的组织架构
3. **权限模板**：预定义权限配置模板
4. **审计增强**：详细的权限变更日志

### 技术优化
1. **权限缓存**：提高权限检查性能
2. **批量操作**：支持批量用户管理
3. **权限继承**：支持权限继承机制
4. **动态权限**：支持运行时权限调整

---

**重要提醒**：在开发过程中，务必严格区分三种用户类型，避免混淆导致的功能错误和安全问题。
