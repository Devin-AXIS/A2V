## AINO 全栈上云改造方案（阿里云函数计算 FC）

### 1. 目标与范围
- 覆盖三个子项目：`AINO-server`（后端 API）、`AINO-APP`（前台应用）、`AINO-studio`（Studio 管理端）。
- 全部运行于阿里云函数计算 FC（优先 Web 函数/自定义运行时），配合 OSS、RDS、SLS、VPC、CDN 形成生产可用的 Serverless 架构。
- 不修改数据库表结构与迁移脚本，不对数据层进行结构性调整（遵循现有约束）。
- Studio 页面配置遵循现有规范：通过接口写入数据库或 JSON 文件，应用打开时自动读取；禁止使用 localStorage 存储页面配置。

### 2. 目标架构总览
- 计算：阿里云函数计算 FC（Node.js 20 自定义运行时），三套独立服务：
  - `aino-server-fc`：承载 Hono API。
  - `aino-app-fc`：承载 Next.js SSR/API（前台）。
  - `aino-studio-fc`：承载 Next.js SSR/API（管理端）。
- 存储：
  - 对象存储 OSS：用户上传、页面配置 JSON 持久化、预览文件、静态资源（`public/` 与 `.next/static`）。
  - 数据库：延用现有 PostgreSQL（RDS PostgreSQL），通过 VPC 内网/安全访问。
- 网络与边界：
  - VPC 内运行 FC 服务，通过专有网络访问 RDS；公网访问通过自定义域名 + CDN（可选）到 FC/OSS。
- 日志与可观测性：日志服务 SLS 收集 `stdout/stderr`，指标与告警接入云监控。

### 3. 现状盘点（关键要点）
- `AINO-server`：
  - 技术栈：TypeScript + Hono，`pg` 直连 PostgreSQL，JWT 鉴权。
  - 文件落盘：`src/modules/page-configs` 与 `src/modules/preview-manifests` 将 JSON 落地到 `uploads/` 目录（运行时 `dist/../../../uploads`）。在 FC 的只读文件系统下不可持续保存；仅 `/tmp` 可写且短暂。
  - 构建/启动：`tsc` 构建，`node dist/server.js` 启动。
- `AINO-APP`（Next 15.5）：
  - `next.config.mjs`：`output: 'standalone'` 已启用；图片域为 `localhost`；有 `rewrites`。
  - 常规 `next start` 运行模式。
- `AINO-studio`（Next 15.2）：
  - 默认配置，未设置 `output: 'standalone'`，`images.unoptimized: true`。

### 4. 迁移影响面与改造项
#### 4.1 运行时与入口适配
- FC Web 函数以 HTTP 触发方式运行，函数应导出可复用的 HTTP 处理器。建议：
  - `AINO-server` 将原本 `listen` 改为导出 `handler(req, res)`，借助 `serverless-http` 或阿里云官方 SDK 进行适配；初始化（创建 DB 连接池等）应放在函数体外，复用冷启动后的单例。
  - `AINO-APP`/`AINO-studio` 运行 Next.js SSR：构建为 `standalone`，在自定义运行时的初始化阶段启动 Next Server 并复用；或拆分静态与 SSR（见 4.3）。

#### 4.2 网络与 VPC
- 为安全与低延迟，将三套 FC 服务放入同一 VPC 与交换机，访问 RDS 内网地址。
- 若需公网出站（第三方 API），配置 NAT 网关或 EIP；入站通过自定义域名（API 网关可选）。

#### 4.3 静态资源与页面构建产物
- 强烈建议拆分：
  - 静态资源（`public/` 与 `.next/static`）上传至 OSS 并挂 CDN。
  - FC 仅处理 SSR 与 API，减小包体、降低冷启动时长。
- 若保留一体化：需将 `standalone` 产物与静态目录一并打包至函数镜像/代码包，带来体积与发布复杂度提升，不推荐。

#### 4.4 本地文件写入改造（uploads/ 与 JSON 持久化）
- FC 文件系统只读，`/tmp` 可写但不持久。将所有“本地落盘”改造为 OSS：
  - `page-configs`：将配置 JSON 写入 `oss://aino-bucket/page-configs/{id}.json`；读取同路径。
  - `preview-manifests`：改为 `oss://aino-bucket/previews/{id}.json`。
  - 其他上传：统一写入 `oss://aino-bucket/uploads/...`。
- 访问策略：
  - 服务端使用 RAM 角色挂载到 FC（最简）或使用 AK/SK+STS 临时凭证（更安全）。
  - 客户端直传采用服务端下发“带签名的表单/URL”，避免大文件通过函数中转。

#### 4.5 上传与下载路径
- 上传：
  - 优先“前端直传 OSS”：Studio/APP 调用 `AINO-server` 获取 STS/签名后，直接 `PUT/POST` 到 OSS；服务端仅做鉴权与回调验证。
  - 兼容小文件中转：在 `AINO-server` 内转存到 OSS，但需关注函数超时与内存占用。
- 下载：
  - 公有读资源直接走 CDN/OSS 域名。
  - 私有读通过服务端下发临时签名 URL（有效期短）。

#### 4.6 环境变量与密钥
- 秘钥与配置（JWT_SECRET、DB_HOST/USER/PASS、OSS_BUCKET、OSS_ENDPOINT 等）统一放入 FC 环境变量；高敏项可用 KMS+密文环境变量。
- 不写入代码仓库；本地开发通过 `.env` 管理。

#### 4.7 数据库连接与池化
- 复用连接池单例：在模块顶层创建 `pg.Pool`，在函数内复用，避免每次冷启动建连成本。
- 并发控制：在 FC 并发放大时，限制池大小，必要时引入 PgBouncer 或连接代理。
- 超时与重试：为短生命周期函数设置合理的查询超时与指数退避重试。

#### 4.8 日志、链路与指标
- 标准输出接入 SLS；按项目/环境打标签（service=aino-server|aino-app|aino-studio, env=prod|staging）。
- 若需要分布式追踪，引入 OpenTelemetry SDK 上报至阿里云可观测平台。

#### 4.9 冷启动与性能优化
- 包体控制：剥离静态资源到 OSS，使用 `output: 'standalone'`，移除不必要依赖。
- 预置并发/预留实例：对生产高峰开启按量保留实例，降低冷启动。
- Node 版本统一为 20；使用 ESM/按需引入减小初始化成本。

#### 4.10 自定义域名与路由
- 通过 FC 自定义域或 API 网关绑定域名：
  - `api.example.com` → `aino-server-fc`
  - `app.example.com` → `aino-app-fc`（SSR）
  - `studio.example.com` → `aino-studio-fc`（SSR）
- 静态资源域名（CDN）`static.example.com` 指向 OSS Bucket。

#### 4.11 计费与成本（概览）
- FC：按请求次数、运行时长与内存计费；SSR 命中率与包体影响显著。
- OSS+CDN：按存储量与下行流量计费；直传可降低函数带宽占用。
- SLS：按写入量与存储保留计费；建议 7~30 天冷热分层。

### 5. 子项目逐项改造建议
#### 5.1 AINO-server（Hono API）
1) 入口与适配：
   - 将 `src/server.ts` 的 `listen` 改为导出 `handler`，在 `dist/server.js` 中可被 FC 入口引用。
   - 使用 `serverless-http` 将 Hono App 适配为 FC 处理器；初始化（DB 连接池、OSS 客户端）在模块顶层创建实现复用。
2) 文件存储抽象：
   - 新增 `FileStore` 接口，提供 `readJSON/writeJSON/putObject/getSignedUrl`；默认实现对接 OSS。
   - 替换 `src/modules/page-configs` 与 `src/modules/preview-manifests` 的本地落盘逻辑为 `FileStore` 实现。
3) 上传改造：
   - 新增获取直传凭证/签名的接口，限制对象前缀、大小与 Content-Type，必要时服务端验证回调。
4) 配置与变量：
   - 通过 FC 环境变量配置 `PG_*`、`JWT_SECRET`、`OSS_*`；本地 `.env` 同步维护。
5) 打包与部署：
   - `pnpm build` → 产物 `dist/`；函数入口指向 `dist/server.handler`（示例）。

#### 5.2 AINO-APP（Next.js 前台）
1) 构建与产物：
   - 保持 `next.config.mjs` 中 `output: 'standalone'`。
   - 构建后将 `.next/standalone/`（SSR）与 `.next/static/`、`public/`（静态）分离。
2) 静态资源：
   - 将 `.next/static` 与 `public` 上传至 OSS+CDN，设置长期缓存；Next Image 如需继续优化，可：
     - 方案 A：`images.unoptimized: true` 改为由 CDN/ImgProxy 处理。
     - 方案 B：保留 Next Image，`images.domains` 加入 CDN 域名。
3) 运行于 FC：
   - Web 函数在初始化阶段启动 Next Server 并持久化；请求进入时直接复用服务实例（避免每次启动）。
4) 环境变量：
   - 将后端 API 基址（`NEXT_PUBLIC_API_BASE`）指向 `aino-server-fc` 自定义域；其它密钥使用 FC 环境变量。

#### 5.3 AINO-studio（Next.js 管理端）
1) 构建与产物：
   - 将 `next.config.mjs` 增加 `output: 'standalone'`（与 APP 一致）。
2) 静态资源与策略：
   - 同 AINO-APP，静态上 OSS+CDN；图片优化策略保持 `images.unoptimized: true` 或切换 CDN 处理。
3) 运行与配置：
   - 同 AINO-APP 的 FC 运行方式与环境变量管理。

### 6. 部署与交付（建议采用 Serverless Devs）
使用 Serverless Devs（`s.yaml`）管理多服务，示例骨架：

```yaml
edition: 1.0.0
name: aino
access: default

services:
  aino-server-fc:
    component: fc3
    props:
      region: cn-hangzhou
      service:
        name: aino-server
        vpcConfig:
          vpcId: ${env(VPC_ID)}
          vswitchIds: [${env(VSWITCH_ID)}]
          securityGroupId: ${env(SG_ID)}
        logConfig:
          project: ${env(SLS_PROJECT)}
          logstore: ${env(SLS_LOGSTORE)}
      function:
        name: api
        runtime: custom.debian10
        cpu: 0.5
        memorySize: 1024
        timeout: 60
        codeUri: ./AINO-server/dist
        handler: server.handler
        environmentVariables:
          PG_HOST: ${env(PG_HOST)}
          PG_USER: ${env(PG_USER)}
          PG_PASSWORD: ${env(PG_PASSWORD)}
          PG_DATABASE: ${env(PG_DATABASE)}
          JWT_SECRET: ${env(JWT_SECRET)}
          OSS_BUCKET: ${env(OSS_BUCKET)}
          OSS_ENDPOINT: ${env(OSS_ENDPOINT)}
        triggers:
          - name: httpTrigger
            type: http
            config:
              authType: anonymous
              methods: [GET, POST, PUT, PATCH, DELETE, OPTIONS]

  aino-app-fc:
    component: fc3
    props:
      # 同上，指向 Next SSR 产物；建议静态走 OSS+CDN

  aino-studio-fc:
    component: fc3
    props:
      # 同上
```

CI/CD 建议：
- 构建阶段：
  - `AINO-server`: `pnpm -C AINO-server build` → 上传 `dist/`。
  - `AINO-APP/Studio`: `pnpm -C AINO-APP build` / `pnpm -C AINO-studio build` → 上传 `.next/standalone/` 到函数；`.next/static` 与 `public/` 发布到 OSS。
- 部署阶段：`s deploy --use-local`，不同环境（staging/prod）通过不同变量组与别名部署。

### 7. 回滚与灰度
- 版本化：函数版本+别名（`prod`/`staging`）；静态资源加版本前缀并保持旧版本短期可访问。
- 灰度：通过别名权重在 FC 实现流量分配；验证通过后切 100%。
- 回滚：函数别名回指上一版本；静态资源回滚到旧前缀并回写 CDN 缓存规则。

### 8. 风险清单与缓解
- 冷启动导致 P99 延迟升高：启用预留实例；控制包体；拆静态。
- 数据库连接爆发：限制连接池大小，必要时引入连接代理；对只读查询使用缓存。
- 大文件上传超时：使用直传与分片；缩短函数链路。
- 本地文件写入缺失：全部改造为 OSS；短时临时文件使用 `/tmp`。
- Next 图片优化兼容：可退回 `unoptimized`+CDN，避免函数内图像处理。

### 9. 验收标准
- 无本地持久化写入（除 `/tmp` 临时），所有持久数据在 OSS/RDS。
- 端到端链路可观测（SLS）并配置告警。
- 在压力测试下（QPS>=既有峰值×1.2）请求成功率≥99.9%、P99 延迟符合指标。
- 灰度/回滚流程在预演环境验证通过。

### 10. 里程碑计划（示例）
- M1（1 周）：PaaS 账户/网络基建、OSS/SLS/RDS/VPC、域名与证书、样例函数跑通。
- M2（1-2 周）：`AINO-server` 适配与上线（含 OSS 存储改造、直传签名）。
- M3（1-2 周）：`AINO-APP` SSR 上线，静态资源迁移到 OSS+CDN。
- M4（1 周）：`AINO-studio` SSR 上线，联调页面配置链路（接口化读取）。
- M5（0.5 周）：全链路压测、告警与灾备演练、灰度切流与生产验证。

### 11. 待落地的代码级改造清单（不在本次提交内）
- `AINO-server`：
  - 新增 `FileStore` 抽象与 OSS 实现；替换 `page-configs`/`preview-manifests` 本地 I/O。
  - 入口导出 `handler` 并适配 FC；新增直传签名接口与鉴权。
- `AINO-APP`：
  - 保持 `standalone`；新增静态产物上传流程；图片优化策略调整。
- `AINO-studio`：
  - 增加 `output: 'standalone'`；同 APP 的静态/运行与变量管理。

附注：遵循“非经授权不改动数据层结构”的约束，方案默认选 OSS 存储 JSON 文件以替代本地 `uploads/` 落盘；如未来允许数据层调整，可评估将部分 JSON 配置入库以强化事务一致性与查询能力。


