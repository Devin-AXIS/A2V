"use strict";exports.id=400,exports.ids=[400],exports.modules={13771:(e,t,r)=>{r.d(t,{S:()=>a});var i=r(82153);function a(){let[e,t]=(0,i.useState)("admin"),r=(0,i.useMemo)(()=>t=>"view"===t||("edit"===t||"delete"===t?"admin"===e||"operator"===e:("bulkDelete"===t||"managePermissions"===t)&&"admin"===e),[e]);return{role:e,setRole:t,can:r}}},78988:(e,t,r)=>{r.d(t,{x:()=>d});var i=r(82153),a=r(16585),o=r(92117),s=r(64304);function d({appId:e,can:t,toast:r}){let{t:d,locale:c}=(0,a.Y)(),{data:n,application:l,modules:u,isLoading:p,error:f,fetchModules:m}=(0,o.v)(e),[h,y]=(0,i.useState)(null),[g,v]=(0,i.useState)(null),[w,b]=(0,i.useState)({kw:"",status:"all",category:"all"}),[C,I]=(0,i.useState)("list"),[z,k]=(0,i.useState)([]),[S,$]=(0,i.useState)({open:!1,dirId:null,recordId:null,tab:"basic"}),[D,F]=(0,i.useState)(!1),[E,M]=(0,i.useState)(!1),[R,x]=(0,i.useState)(!1),[A,q]=(0,i.useState)(!1),[O,_]=(0,i.useState)(""),[K,V]=(0,i.useState)(!1),[P,L]=(0,i.useState)(""),[T,j]=(0,i.useState)(null),[B,N]=(0,i.useState)(!1),[Y,G]=(0,i.useState)(!1),[H,J]=(0,i.useState)({}),[Q,U]=(0,i.useState)({}),[W,X]=(0,i.useState)({}),[Z,ee]=(0,i.useState)({}),et=async t=>{if(!Q[t]){U(e=>({...e,[t]:!0}));try{let r=await s.api.directories.getDirectories({applicationId:e,moduleId:t});if(r.success&&r.data){let i=r.data.directories.filter(e=>"c9f11a42-19fc-4e3f-a9d3-0e6ffa695b1b"!==e.id||(console.warn(`跳过已知不存在的目录ID: ${e.id}`),!1)),a=(await Promise.all(i.map(async t=>{let r=t.config?.fields||[];try{let i;try{i=await s.api.directories.getDirectory(t.id)}catch(e){return console.warn(`目录 ${t.id} 检查失败，跳过处理:`,e),null}if(!i.success)return console.warn(`目录 ${t.id} 不存在，跳过处理`),null;let a=await s.api.directoryDefs.getOrCreateDirectoryDefByDirectoryId(t.id,e);if(a.success&&a.data?.id){let e=await s.api.fields.getFields({directoryId:a.data.id,page:1,limit:100});e.success&&e.data&&(r=e.data.map((e,t)=>({id:e.id,key:e.key,label:e.schema?.label||e.key,type:e.type,required:e.required||!1,unique:!1,showInList:e.schema?.showInList??!0,showInForm:e.schema?.showInForm??!0,showInDetail:e.schema?.showInDetail??!0,placeholder:e.schema?.placeholder||"",desc:e.schema?.description||"",options:e.schema?.options||[],config:e.schema||{},validators:e.validators||{},enabled:!0,locked:!1,metaItemsConfig:e.schema?.metaItemsConfig||void 0,cascaderOptions:e.schema?.cascaderOptions||void 0,customExperienceConfig:e.schema?.customExperienceConfig||void 0,certificateConfig:e.schema?.certificateConfig||void 0,skillsConfig:e.schema?.skillsConfig||void 0,progressConfig:e.schema?.progressConfig||void 0,identityVerificationConfig:e.schema?.identityVerificationConfig||void 0,otherVerificationConfig:e.schema?.otherVerificationConfig||void 0,imageConfig:e.schema?.imageConfig||void 0,videoConfig:e.schema?.videoConfig||void 0,booleanConfig:e.schema?.booleanConfig||void 0,multiselectConfig:e.schema?.multiselectConfig||void 0,preset:e.schema?.preset||void 0,order:e.order??t,relation:e.relation?{targetDirId:e.relation.targetDirId||null,mode:e.relation.mode||("relation_one"===e.type?"one":"many"),displayFieldKey:e.relation.displayFieldKey||null}:void 0})))}}catch(e){console.warn(`获取目录 ${t.id} 的定义失败:`,e)}let i=[];try{let r=await s.api.recordCategories.getRecordCategories({applicationId:e,directoryId:t.id});r.success&&r.data?.categories&&(i=ey(r.data.categories))}catch(e){console.error("获取分类数据失败:",e),i=t.config?.categories||[]}return{id:t.id,name:t.name,type:t.type,fields:r,categories:i,records:[]}}))).filter(e=>null!==e);J(e=>({...e,[t]:a}))}}catch(e){console.error("获取目录数据失败:",e),r({description:"zh"===c?"获取目录数据失败":"Failed to fetch directories",variant:"destructive"})}finally{U(e=>({...e,[t]:!1}))}}},er=(0,i.useRef)({}),ei=(0,i.useCallback)(async e=>{if(er.current[e]){console.log("\uD83D\uDD0D 记录正在加载中，跳过重复请求:",e);return}console.log("\uD83D\uDD0D 开始获取记录数据:",e),er.current[e]=!0,ee(t=>({...t,[e]:!0}));try{let t=[],r=await s.api.records.listRecords(e,{page:1,pageSize:20});r.success&&r.data&&(t=Array.isArray(r.data)?r.data:r.data.records||r.data,console.log("\uD83D\uDD0D 记录数据获取成功:",e,"记录数量:",t.length)),X(r=>({...r,[e]:t}))}catch(e){console.error("获取记录数据失败:",e),r({description:"zh"===c?"获取记录数据失败":"Failed to fetch records",variant:"destructive"})}finally{er.current[e]=!1,ee(t=>({...t,[e]:!1}))}},[r,c,u,H,e]),ea=(0,i.useMemo)(()=>u.map(e=>({id:e.id,name:e.name,type:e.type,icon:e.icon,directories:(H[e.id]||[]).map(e=>({...e,records:[]}))})),[u,H]),eo=(0,i.useMemo)(()=>h&&ea.find(e=>e.id===h)||null,[ea,h]),es=(0,i.useMemo)(()=>{if(!eo||!g)return null;let e=eo.directories.find(e=>e.id===g);return e?{...e,records:W[e.id]||[]}:null},[eo,g,W]);async function ed(i){if(eo){if(!t("edit")){r({description:"zh"===c?"当前角色无权创建目录":"Current role has no permission to create directory",variant:"destructive"});return}try{let t=await s.api.directories.createDirectory({name:i.name,type:"table",supportsCategory:!1,config:{},order:0},{applicationId:e,moduleId:eo.id});t.success&&t.data&&(await et(eo.id),v(t.data.id),M(!1),r({description:"zh"===c?`目录「${i.name}」创建成功`:`Directory "${i.name}" created successfully`}))}catch(e){console.error("创建目录失败:",e),r({description:"zh"===c?"创建目录失败":"Failed to create directory",variant:"destructive"})}}}async function ec(i){if(l&&t("edit")){console.log("\uD83D\uDD0D 开始创建模块:",{appId:e,payload:i});try{let t=await s.api.modules.installModuleSimple(e,{moduleKey:i.templateKey,installConfig:{name:i.name.trim(),icon:i.icon}});if(console.log("\uD83D\uDD0D API响应:",t),t.success)F(!1),console.log("\uD83D\uDD04 模块创建成功，开始刷新数据..."),await m(),console.log("✅ 模块数据刷新完成"),r({title:"zh"===c?"模块创建成功":"Module Created Successfully",description:"zh"===c?`模块 "${i.name}" 已创建`:`Module "${i.name}" has been created`});else throw Error(t.error||"模块创建失败")}catch(t){console.error("❌ 创建模块失败:",t);let e=t instanceof Error?t.message:String(t);console.log("\uD83D\uDD0D 错误信息:",e),e.includes("模块已安装")||e.includes("already installed")?r({title:"zh"===c?"模块已存在":"Module Already Exists",description:"zh"===c?`模块 "${i.name}" 已经安装，请选择其他模块`:`Module "${i.name}" is already installed, please choose another module`,variant:"destructive"}):r({title:"zh"===c?"创建模块失败":"Failed to Create Module",description:"zh"===c?`错误: ${e}`:`Error: ${e}`,variant:"destructive"})}}}async function en(e,t,i){try{console.log("\uD83D\uDD0D 保存记录:",{dirId:e,recordId:t,props:i});let a=await s.api.records.updateRecord(e,t,{props:i});if(a.success&&a.data)return await ei(e),r({description:"zh"===c?"记录保存成功":"Record saved successfully"}),a.data;throw Error(a.error||"保存记录失败")}catch(e){throw console.error("保存记录失败:",e),r({description:"zh"===c?"保存记录失败":"Failed to save record",variant:"destructive"}),e}}async function el(){if(es){if(!t("edit")){r({description:"zh"===c?"当前角色无权添加记录":"Current role has no permission to add record",variant:"destructive"});return}try{es.categories&&es.categories.length>0?G(!0):await eu("")}catch(e){console.error("添加记录失败:",e),r({description:"zh"===c?"添加记录失败":"Failed to add record",variant:"destructive"})}}}async function eu(e){if(es)try{let t={};es.fields.forEach(r=>{let i;if(void 0!==r.default){t[r.key]=r.default;return}switch(r.type){case"select":i="category"===r.key&&e?e:r.options?.[0]??"";break;case"multiselect":case"tags":case"experience":i=[];break;case"boolean":case"checkbox":i=!1;break;case"number":case"percent":i=0;break;case"relation_one":case"relation_many":i="relation_many"===r.type?[]:"";break;case"email":i=r.required?"example@example.com":"";break;case"image":case"profile":i=r.required?"https://via.placeholder.com/150x150?text=Image":"";break;case"date":i=r.required?new Date().toISOString().split("T")[0]:"";break;case"datetime":i=r.required?new Date().toISOString():"";break;default:i=r.required?`${r.label||r.key}_示例值`:""}t[r.key]=i});let i=es.fields.find(e=>"name"===e.key||"title"===e.key);if(i&&!t[i.key]){let e=(W[es.id]||[]).length;t[i.key]=`${i.label||"新记录"}#${e+1}`}console.log("\uD83D\uDD0D 创建记录:",{dirId:es.id,dirName:es.name,props:t,fieldsInfo:es.fields.map(e=>({key:e.key,type:e.type,required:e.required,label:e.label}))});let a=await s.api.records.createRecord(es.id,{props:t});if(a.success&&a.data){console.log("\uD83D\uDD0D 记录创建成功，返回数据:",a.data);let e=a.data;X(t=>({...t,[es.id]:[...t[es.id]||[],e]}));let t=a.data.id;console.log("\uD83D\uDD0D 准备打开抽屉:",{dirId:es.id,recordId:t,tab:"basic"}),$({open:!0,dirId:es.id,recordId:t,tab:"basic"}),r({description:"zh"===c?"记录创建成功":"Record created successfully"})}else throw console.error("\uD83D\uDD0D 记录创建失败:",a),Error(a.error||"创建记录失败")}catch(e){console.error("创建记录失败:",e),r({description:"zh"===c?"创建记录失败":"Failed to create record",variant:"destructive"})}}async function ep(e){if(!t("edit")){r({description:"zh"===c?"当前角色无权重命名目录":"Current role has no permission to rename directory",variant:"destructive"});return}j(e.id),L(e.name),V(!0)}async function ef(e){if(!eo||!T)return;let t=(e||P).trim();if(t)try{(await s.api.directories.updateDirectory(T,{name:t})).success&&(await et(eo.id),r({description:"zh"===c?`目录重命名为「${t}」`:`Directory renamed to "${t}"`}),V(!1))}catch(e){console.error("重命名目录失败:",e),r({description:"zh"===c?"重命名目录失败":"Failed to rename directory",variant:"destructive"})}}async function em(e){if(eo){if(!t("delete")){r({description:"zh"===c?"当前角色无权删除目录":"Current role has no permission to delete directory",variant:"destructive"});return}if(e.records&&e.records.length>0){r({description:"zh"===c?`无法删除目录「${e.name}」，请先删除目录中的 ${e.records.length} 条记录`:`Cannot delete directory "${e.name}", please delete ${e.records.length} records first`,variant:"destructive"});return}try{if((await s.api.directories.deleteDirectory(e.id)).success){if(await et(eo.id),g===e.id){let t=H[eo.id]?.filter(t=>t.id!==e.id)||[];v(t.length>0?t[0].id:null)}r({description:"zh"===c?`目录「${e.name}」已删除`:`Directory "${e.name}" deleted`})}}catch(e){console.error("删除目录失败:",e),r({description:"zh"===c?"删除目录失败":"Failed to delete directory",variant:"destructive"})}}}async function eh(t){if(es&&e)try{console.log("\uD83D\uDD0D 保存分类数据:",t);let i=await s.api.recordCategories.getRecordCategories({applicationId:e,directoryId:es.id});if(i.success&&i.data?.categories)for(let e of(console.log("\uD83D\uDDD1️ 删除现有分类，数量:",i.data.categories.length),i.data.categories.sort((e,t)=>(t.level||1)-(e.level||1))))try{console.log("\uD83D\uDDD1️ 删除分类:",e.name,"level:",e.level),await s.api.recordCategories.deleteRecordCategory(e.id)}catch(t){console.warn("删除分类失败:",e.id,e.name,t)}let a=function e(t,r=null,i=1){let a=[];return t.forEach((t,o)=>{let s=t.id||`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,d={id:t.id,tempId:s,name:t.name,parentId:r,level:i,order:o,enabled:!1!==t.enabled};if(a.push(d),t.children&&t.children.length>0){let r=e(t.children,t.id||s,i+1);a.push(...r)}}),a}(t);console.log("\uD83D\uDD04 扁平化分类:",a);let o=new Map;a.forEach(e=>{let t=e.level||1;o.has(t)||o.set(t,[]),o.get(t).push(e)});let d=new Map;for(let t of Array.from(o.keys()).sort())for(let r of o.get(t)){console.log("➕ 创建分类:",r.name,"level:",t);let i=null;r.parentId&&d.has(r.parentId)&&(i=d.get(r.parentId));let a=await s.api.recordCategories.createRecordCategory({name:r.name,...i&&{parentId:i},order:r.order||0,enabled:!1!==r.enabled},{applicationId:e,directoryId:es.id});a.success&&a.data?(d.set(r.tempId,a.data.id),console.log("✅ 分类创建成功:",r.name,"ID:",a.data.id)):console.error("❌ 分类创建失败:",r.name,a)}let n=await s.api.recordCategories.getRecordCategories({applicationId:e,directoryId:es.id});if(n.success){let e=ey(n.data?.categories||[]),t={...es,categories:e};J(e=>({...e,[eo?.id||""]:e[eo?.id||""]?.map(e=>e.id===es.id?t:e)||[]})),r({description:"zh"===c?"分类保存成功":"Categories saved successfully"}),N(!1)}else throw Error(n.error||"获取更新后的分类失败")}catch(e){console.error("保存分类失败:",e),r({description:"zh"===c?"保存分类失败，请重试":"Failed to save categories, please try again",variant:"destructive"})}}function ey(e){let t=new Map,r=[];e.forEach(e=>{t.set(e.id,{...e,children:[]})}),e.forEach(e=>{let i=t.get(e.id);e.parentId&&t.has(e.parentId)?t.get(e.parentId).children.push(i):r.push(i)});let i=e=>{e.sort((e,t)=>(e.order||0)-(t.order||0)),e.forEach(e=>{e.children.length>0&&i(e.children)})};return i(r),r}async function eg(e){if(es){if(!t("delete")){r({description:"zh"===c?"当前角色无权删除记录":"Current role has no permission to delete record",variant:"destructive"});return}try{(await s.api.records.deleteRecord(es.id,e)).success&&(await ei(es.id),r({description:"zh"===c?"记录删除成功":"Record deleted successfully"}))}catch(e){console.error("删除记录失败:",e),r({description:"zh"===c?"删除记录失败":"Failed to delete record",variant:"destructive"})}}}async function ev(){if(es){if(!t("bulkDelete")){r({description:"zh"===c?"当前角色无权批量删除":"Current role has no permission to bulk delete",variant:"destructive"});return}if(0!==z.length&&confirm("zh"===c?`确定要删除选中的 ${z.length} 条记录吗？此操作不可撤销。`:`Are you sure you want to delete ${z.length} selected records? This action cannot be undone.`))try{let e=await s.api.records.bulkDeleteRecords(es.id,z);if(e.success&&e.data){let{deletedCount:t,failedCount:i}=e.data;await ei(es.id),k([]),0===i?r({description:"zh"===c?`成功删除 ${t} 条记录`:`Successfully deleted ${t} records`}):r({description:"zh"===c?`删除了 ${t} 条记录，${i} 条删除失败`:`Deleted ${t} records, ${i} failed`,variant:"destructive"})}}catch(e){console.error("批量删除记录失败:",e),r({description:"zh"===c?"批量删除记录失败":"Failed to bulk delete records",variant:"destructive"})}}}return{app:l?{id:l.id,name:l.name,desc:l.description,modules:ea}:null,modules:ea,currentModule:eo,currentDir:es,records:es&&W[es.id]||[],moduleId:h,setModuleId:y,dirId:g,setDirId:v,filters:w,setFilters:b,tab:C,setTab:I,selectedIds:z,setSelectedIds:k,drawer:S,setDrawer:$,openAddModule:D,setOpenAddModule:F,openAddDir:E,setOpenAddDir:M,openAddField:R,setOpenAddField:x,renameModuleOpen:A,setRenameModuleOpen:q,renameModuleName:O,setRenameModuleName:_,renameDirOpen:K,setRenameDirOpen:V,renameDirName:P,setRenameDirName:L,renameDirTargetId:T,setRenameDirTargetId:j,openCategory:B,setOpenCategory:N,openCategorySelection:Y,setOpenCategorySelection:G,isLoading:p,error:f,refresh:m,persist:function(e){try{if(!e||!e.modules)return;J(t=>{let r={...t};for(let i of e.modules||[]){if(!i||!i.id)continue;let e=(i.directories||[]).map(e=>{let r=(t[i.id]||[]).find(t=>t.id===e.id);return{id:e.id,name:e.name,type:e.type,fields:Array.isArray(e.fields)?e.fields.slice():[],categories:e.categories??r?.categories??[],records:r?.records??[]}});r[i.id]=e}return r})}catch(e){console.warn("persist 合并目录数据失败:",e)}},updateDirectoryFields:function(e,t,r){try{J(i=>{let a=(i[e]||[]).map(e=>e.id!==t?e:{...e,fields:Array.isArray(r)?r.slice():[]});return{...i,[e]:a}})}catch(e){console.warn("updateDirectoryFields 失败:",e)}},saveRecord:en,addRecord:el,openDrawer:function(e,t){$({open:!0,dirId:e,recordId:t,tab:"basic"})},closeDrawer:function(){$({open:!1,dirId:null,recordId:null,tab:"basic"})},quickOpenAddField:function(){x(!0)},handleCreateModuleFromDialog:ec,handleCreateDirectoryFromDialog:ed,openRenameModule:function(){eo&&(_(eo.name),q(!0))},handleRenameModule:function(e){if(eo){if(!t("edit")){r({description:"zh"===c?"当前角色无权重命名模块":"Current role has no permission to rename module",variant:"destructive"});return}(e||O).trim()&&(r({description:"zh"===c?"重命名模块功能正在开发中":"Rename module feature is under development"}),q(!1))}},renameDir:ep,handleRenameDir:ef,deleteDir:em,handleSaveCategories:eh,handleSingleDelete:eg,handleBulkDelete:ev,createRecordWithCategory:eu}}},92117:(e,t,r)=>{r.d(t,{v:()=>s});var i=r(82153),a=r(64304),o=r(14618);function s(e,t={}){let{autoFetch:r=!0}=t,{toast:d}=(0,o.dj)(),[c,n]=(0,i.useState)(null),[l,u]=(0,i.useState)(!1),[p,f]=(0,i.useState)(null),m=(0,i.useCallback)(async()=>{if(e){u(!0),f(null);try{console.log("\uD83D\uDCCB 获取应用模块列表...",e);let t=await a.api.applications.getApplicationModules(e);if(t.success&&t.data)n(t.data),console.log("✅ 应用模块获取成功:",t.data.modules.length,"个模块"),console.log("\uD83D\uDCCB 模块列表:",t.data.modules.map(e=>`${e.name} (${e.type})`));else throw Error(t.error||"获取应用模块失败")}catch(t){let e=t instanceof Error?t.message:"获取应用模块失败";f(e),console.error("❌ 获取应用模块失败:",t),d({title:"获取应用模块失败",description:e,variant:"destructive"})}finally{u(!1)}}},[e,d]);return{data:c,application:c?.application,modules:c?.modules||[],isLoading:l,error:p,fetchModules:m}}}};