"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9598],{16585:(e,t,i)=>{i.d(t,{v:()=>c});var r=i(10640),o=i(91650),a=i(6712);function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{autoFetch:i=!0}=t,{toast:c}=(0,a.dj)(),[d,n]=(0,r.useState)(null),[l,s]=(0,r.useState)(!1),[u,f]=(0,r.useState)(null),p=(0,r.useCallback)(async()=>{if(e){s(!0),f(null);try{console.log("\uD83D\uDCCB 获取应用模块列表...",e);let t=await o.api.applications.getApplicationModules(e);if(t.success&&t.data)n(t.data),console.log("✅ 应用模块获取成功:",t.data.modules.length,"个模块"),console.log("\uD83D\uDCCB 模块列表:",t.data.modules.map(e=>"".concat(e.name," (").concat(e.type,")")));else throw Error(t.error||"获取应用模块失败")}catch(t){let e=t instanceof Error?t.message:"获取应用模块失败";f(e),console.error("❌ 获取应用模块失败:",t),c({title:"获取应用模块失败",description:e,variant:"destructive"})}finally{s(!1)}}},[e,c]);return(0,r.useEffect)(()=>{i&&e&&p()},[i,e,p]),{data:d,application:null==d?void 0:d.application,modules:(null==d?void 0:d.modules)||[],isLoading:l,error:u,fetchModules:p}}},63727:(e,t,i)=>{i.d(t,{S:()=>a});var r=i(10640);let o="nocode_role";function a(){let[e,t]=(0,r.useState)("admin");(0,r.useEffect)(()=>{try{let e=localStorage.getItem(o)||"admin";t(e)}catch(e){}},[]),(0,r.useEffect)(()=>{try{localStorage.setItem(o,e)}catch(e){}},[e]);let i=(0,r.useMemo)(()=>t=>"view"===t||("edit"===t||"delete"===t?"admin"===e||"operator"===e:("bulkDelete"===t||"managePermissions"===t)&&"admin"===e),[e]);return{role:e,setRole:t,can:i}}},73246:(e,t,i)=>{i.d(t,{x:()=>d});var r=i(10640),o=i(73475),a=i(16585),c=i(91650);function d(e){let{appId:t,can:i,toast:d}=e,{t:n,locale:l}=(0,o.Y)(),{data:s,application:u,modules:f,isLoading:p,error:v,fetchModules:m}=(0,a.v)(t),[h,y]=(0,r.useState)(null),[g,w]=(0,r.useState)(null),[b,I]=(0,r.useState)({kw:"",status:"all",category:"all"}),[C,k]=(0,r.useState)("list"),[S,z]=(0,r.useState)([]),[D,E]=(0,r.useState)({open:!1,dirId:null,recordId:null,tab:"basic"}),[F,M]=(0,r.useState)(!1),[R,A]=(0,r.useState)(!1),[q,x]=(0,r.useState)(!1),[_,N]=(0,r.useState)(!1),[O,T]=(0,r.useState)(""),[K,V]=(0,r.useState)(!1),[P,L]=(0,r.useState)(""),[j,B]=(0,r.useState)(null),[Y,G]=(0,r.useState)(!1),[H,J]=(0,r.useState)(!1),[Q,U]=(0,r.useState)({}),[W,X]=(0,r.useState)({}),[Z,$]=(0,r.useState)({}),[ee,et]=(0,r.useState)({}),[ei,er]=(0,r.useState)(0),eo=()=>er(e=>e+1),ea=async e=>{if(!W[e]){X(t=>({...t,[e]:!0}));try{let i=await c.api.directories.getDirectories({applicationId:t,moduleId:e});if(i.success&&i.data){let r=i.data.directories.filter(e=>"c9f11a42-19fc-4e3f-a9d3-0e6ffa695b1b"!==e.id||(console.warn("跳过已知不存在的目录ID: ".concat(e.id)),!1)),o=(await Promise.all(r.map(async e=>{var i,r,o,a;let d=(null===(i=e.config)||void 0===i?void 0:i.fields)||[];try{let i;try{i=await c.api.directories.getDirectory(e.id)}catch(t){return console.warn("目录 ".concat(e.id," 检查失败，跳过处理:"),t),null}if(!i.success)return console.warn("目录 ".concat(e.id," 不存在，跳过处理")),null;let o=await c.api.directoryDefs.getOrCreateDirectoryDefByDirectoryId(e.id,t);if(o.success&&(null===(r=o.data)||void 0===r?void 0:r.id)){let e=await c.api.fields.getFields({directoryId:o.data.id,page:1,limit:100});e.success&&e.data&&(d=e.data.map((e,t)=>{var i,r,o,a,c,d,n,l,s,u,f,p,v,m,h,y,g,w,b,I,C,k,S,z;return{id:e.id,key:e.key,label:(null===(i=e.schema)||void 0===i?void 0:i.label)||e.key,type:e.type,required:e.required||!1,unique:!1,showInList:null===(C=null===(r=e.schema)||void 0===r?void 0:r.showInList)||void 0===C||C,showInForm:null===(k=null===(o=e.schema)||void 0===o?void 0:o.showInForm)||void 0===k||k,showInDetail:null===(S=null===(a=e.schema)||void 0===a?void 0:a.showInDetail)||void 0===S||S,placeholder:(null===(c=e.schema)||void 0===c?void 0:c.placeholder)||"",desc:(null===(d=e.schema)||void 0===d?void 0:d.description)||"",options:(null===(n=e.schema)||void 0===n?void 0:n.options)||[],config:e.schema||{},validators:e.validators||{},enabled:!0,locked:!1,metaItemsConfig:(null===(l=e.schema)||void 0===l?void 0:l.metaItemsConfig)||void 0,cascaderOptions:(null===(s=e.schema)||void 0===s?void 0:s.cascaderOptions)||void 0,customExperienceConfig:(null===(u=e.schema)||void 0===u?void 0:u.customExperienceConfig)||void 0,certificateConfig:(null===(f=e.schema)||void 0===f?void 0:f.certificateConfig)||void 0,skillsConfig:(null===(p=e.schema)||void 0===p?void 0:p.skillsConfig)||void 0,progressConfig:(null===(v=e.schema)||void 0===v?void 0:v.progressConfig)||void 0,identityVerificationConfig:(null===(m=e.schema)||void 0===m?void 0:m.identityVerificationConfig)||void 0,otherVerificationConfig:(null===(h=e.schema)||void 0===h?void 0:h.otherVerificationConfig)||void 0,imageConfig:(null===(y=e.schema)||void 0===y?void 0:y.imageConfig)||void 0,videoConfig:(null===(g=e.schema)||void 0===g?void 0:g.videoConfig)||void 0,booleanConfig:(null===(w=e.schema)||void 0===w?void 0:w.booleanConfig)||void 0,multiselectConfig:(null===(b=e.schema)||void 0===b?void 0:b.multiselectConfig)||void 0,preset:(null===(I=e.schema)||void 0===I?void 0:I.preset)||void 0,order:null!==(z=e.order)&&void 0!==z?z:t,relation:e.relation?{targetDirId:e.relation.targetDirId||null,mode:e.relation.mode||("relation_one"===e.type?"one":"many"),displayFieldKey:e.relation.displayFieldKey||null}:void 0}}))}}catch(t){console.warn("获取目录 ".concat(e.id," 的定义失败:"),t)}let n=[];try{let i=await c.api.recordCategories.getRecordCategories({applicationId:t,directoryId:e.id});i.success&&(null===(o=i.data)||void 0===o?void 0:o.categories)&&(n=eb(i.data.categories))}catch(t){console.error("获取分类数据失败:",t),n=(null===(a=e.config)||void 0===a?void 0:a.categories)||[]}return{id:e.id,name:e.name,type:e.type,fields:d,categories:n,records:[]}}))).filter(e=>null!==e);U(t=>({...t,[e]:o}))}}catch(e){console.error("获取目录数据失败:",e),d({description:"zh"===l?"获取目录数据失败":"Failed to fetch directories",variant:"destructive"})}finally{X(t=>({...t,[e]:!1}))}}},ec=(0,r.useRef)({}),ed=(0,r.useCallback)(async e=>{if(ec.current[e]){console.log("\uD83D\uDD0D 记录正在加载中，跳过重复请求:",e);return}console.log("\uD83D\uDD0D 开始获取记录数据:",e),ec.current[e]=!0,et(t=>({...t,[e]:!0}));try{let t=[],i=await c.api.records.listRecords(e,{page:1,pageSize:20});i.success&&i.data&&(t=Array.isArray(i.data)?i.data:i.data.records||i.data,console.log("\uD83D\uDD0D 记录数据获取成功:",e,"记录数量:",t.length)),$(i=>({...i,[e]:t}))}catch(e){console.error("获取记录数据失败:",e),d({description:"zh"===l?"获取记录数据失败":"Failed to fetch records",variant:"destructive"})}finally{ec.current[e]=!1,et(t=>({...t,[e]:!1}))}},[d,l,f,Q,t]),en=(0,r.useMemo)(()=>f.map(e=>({id:e.id,name:e.name,type:e.type,icon:e.icon,directories:(Q[e.id]||[]).map(e=>({...e,records:[]}))})),[f,Q]);(0,r.useEffect)(()=>{en.length>0&&!h&&y(en[0].id)},[en,h]),(0,r.useEffect)(()=>{h&&t&&ea(h)},[h,t]);let el=(0,r.useMemo)(()=>h&&en.find(e=>e.id===h)||null,[en,h]);(0,r.useEffect)(()=>{el&&!g&&el.directories.length>0&&w(el.directories[0].id)},[el,g]);let es=(0,r.useMemo)(()=>{if(!el||!g)return null;let e=el.directories.find(e=>e.id===g);return e?{...e,records:Z[e.id]||[]}:null},[el,g,Z]);async function eu(e){if(el){if(!i("edit")){d({description:"zh"===l?"当前角色无权创建目录":"Current role has no permission to create directory",variant:"destructive"});return}try{let i=await c.api.directories.createDirectory({name:e.name,type:"table",supportsCategory:!1,config:{},order:0},{applicationId:t,moduleId:el.id});i.success&&i.data&&(await ea(el.id),w(i.data.id),A(!1),d({description:"zh"===l?"目录「".concat(e.name,"」创建成功"):'Directory "'.concat(e.name,'" created successfully')}))}catch(e){console.error("创建目录失败:",e),d({description:"zh"===l?"创建目录失败":"Failed to create directory",variant:"destructive"})}}}async function ef(e){if(u&&i("edit")){console.log("\uD83D\uDD0D 开始创建模块:",{appId:t,payload:e});try{let i={name:e.name.trim(),icon:e.icon};"blank-template"!==e.templateKey&&e.defaultTableName&&e.defaultTableName.trim()&&(i.defaultTableName=e.defaultTableName.trim());let r=await c.api.modules.installModuleSimple(t,{moduleKey:e.templateKey,installConfig:i});if(console.log("\uD83D\uDD0D API响应:",r),r.success)M(!1),console.log("\uD83D\uDD04 模块创建成功，开始刷新数据..."),await m(),console.log("✅ 模块数据刷新完成"),d({title:"zh"===l?"模块创建成功":"Module Created Successfully",description:"zh"===l?'模块 "'.concat(e.name,'" 已创建'):'Module "'.concat(e.name,'" has been created')});else throw Error(r.error||"模块创建失败")}catch(i){console.error("❌ 创建模块失败:",i);let t=i instanceof Error?i.message:String(i);console.log("\uD83D\uDD0D 错误信息:",t),t.includes("模块已安装")||t.includes("already installed")?d({title:"zh"===l?"模块已存在":"Module Already Exists",description:"zh"===l?'模块 "'.concat(e.name,'" 已经安装，请选择其他模块'):'Module "'.concat(e.name,'" is already installed, please choose another module'),variant:"destructive"}):d({title:"zh"===l?"创建模块失败":"Failed to Create Module",description:"zh"===l?"错误: ".concat(t):"Error: ".concat(t),variant:"destructive"})}}}async function ep(e,t,i){try{console.log("\uD83D\uDD0D 保存记录:",{dirId:e,recordId:t,props:i});let r=await c.api.records.updateRecord(e,t,{props:i});if(r.success&&r.data)return await ed(e),eo(),d({description:"zh"===l?"记录保存成功":"Record saved successfully"}),r.data;throw Error(r.error||"保存记录失败")}catch(e){throw console.error("保存记录失败:",e),d({description:"zh"===l?"保存记录失败":"Failed to save record",variant:"destructive"}),e}}async function ev(){if(es){if(!i("edit")){d({description:"zh"===l?"当前角色无权添加记录":"Current role has no permission to add record",variant:"destructive"});return}try{es.categories&&es.categories.length>0?J(!0):await em("")}catch(e){console.error("添加记录失败:",e),d({description:"zh"===l?"添加记录失败":"Failed to add record",variant:"destructive"})}}}async function em(e){if(es)try{let t={};es.fields.forEach(i=>{let r;if(void 0!==i.default){t[i.key]=i.default;return}switch(i.type){case"select":if("category"===i.key&&e)r=e;else{var o,a;r=null!==(a=null===(o=i.options)||void 0===o?void 0:o[0])&&void 0!==a?a:""}break;case"multiselect":case"tags":case"experience":r=[];break;case"boolean":case"checkbox":r=!1;break;case"number":case"percent":r=0;break;case"relation_one":case"relation_many":r="relation_many"===i.type?[]:"";break;case"email":r=i.required?"example@example.com":"";break;case"image":case"profile":r=i.required?"https://via.placeholder.com/150x150?text=Image":"";break;case"date":r=i.required?new Date().toISOString().split("T")[0]:"";break;case"datetime":r=i.required?new Date().toISOString():"";break;default:r=i.required?"".concat(i.label||i.key,"_示例值"):""}t[i.key]=r});let i=es.fields.find(e=>"name"===e.key||"title"===e.key);if(i&&!t[i.key]){let e=(Z[es.id]||[]).length;t[i.key]="".concat(i.label||"新记录","#").concat(e+1)}console.log("\uD83D\uDD0D 创建记录:",{dirId:es.id,dirName:es.name,props:t,fieldsInfo:es.fields.map(e=>({key:e.key,type:e.type,required:e.required,label:e.label}))});let r=await c.api.records.createRecord(es.id,{props:t});if(r.success&&r.data){console.log("\uD83D\uDD0D 记录创建成功，返回数据:",r.data);let e=r.data;$(t=>({...t,[es.id]:[...t[es.id]||[],e]})),eo();let t=r.data.id;console.log("\uD83D\uDD0D 准备打开抽屉:",{dirId:es.id,recordId:t,tab:"basic"}),E({open:!0,dirId:es.id,recordId:t,tab:"basic"}),d({description:"zh"===l?"记录创建成功":"Record created successfully"})}else throw console.error("\uD83D\uDD0D 记录创建失败:",r),Error(r.error||"创建记录失败")}catch(e){console.error("创建记录失败:",e),d({description:"zh"===l?"创建记录失败":"Failed to create record",variant:"destructive"})}}async function eh(e){if(!i("edit")){d({description:"zh"===l?"当前角色无权重命名目录":"Current role has no permission to rename directory",variant:"destructive"});return}B(e.id),L(e.name),V(!0)}async function ey(e){if(!el||!j)return;let t=(e||P).trim();if(t)try{(await c.api.directories.updateDirectory(j,{name:t})).success&&(await ea(el.id),d({description:"zh"===l?"目录重命名为「".concat(t,"」"):'Directory renamed to "'.concat(t,'"')}),V(!1))}catch(e){console.error("重命名目录失败:",e),d({description:"zh"===l?"重命名目录失败":"Failed to rename directory",variant:"destructive"})}}async function eg(e){if(el){if(!i("delete")){d({description:"zh"===l?"当前角色无权删除目录":"Current role has no permission to delete directory",variant:"destructive"});return}if(e.records&&e.records.length>0){d({description:"zh"===l?"无法删除目录「".concat(e.name,"」，请先删除目录中的 ").concat(e.records.length," 条记录"):'Cannot delete directory "'.concat(e.name,'", please delete ').concat(e.records.length," records first"),variant:"destructive"});return}try{if((await c.api.directories.deleteDirectory(e.id)).success){if(await ea(el.id),g===e.id){var t;let i=(null===(t=Q[el.id])||void 0===t?void 0:t.filter(t=>t.id!==e.id))||[];w(i.length>0?i[0].id:null)}d({description:"zh"===l?"目录「".concat(e.name,"」已删除"):'Directory "'.concat(e.name,'" deleted')})}}catch(e){console.error("删除目录失败:",e),d({description:"zh"===l?"删除目录失败":"Failed to delete directory",variant:"destructive"})}}}async function ew(e){if(es&&t)try{var i,r;console.log("\uD83D\uDD0D 保存分类数据:",e);let o=await c.api.recordCategories.getRecordCategories({applicationId:t,directoryId:es.id});if(o.success&&(null===(i=o.data)||void 0===i?void 0:i.categories))for(let e of(console.log("\uD83D\uDDD1️ 删除现有分类，数量:",o.data.categories.length),o.data.categories.sort((e,t)=>(t.level||1)-(e.level||1))))try{console.log("\uD83D\uDDD1️ 删除分类:",e.name,"level:",e.level),await c.api.recordCategories.deleteRecordCategory(e.id)}catch(t){console.warn("删除分类失败:",e.id,e.name,t)}let a=function e(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,o=[];return t.forEach((t,a)=>{let c=t.id||"temp-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),d={id:t.id,tempId:c,name:t.name,parentId:i,level:r,order:a,enabled:!1!==t.enabled};if(o.push(d),t.children&&t.children.length>0){let i=e(t.children,t.id||c,r+1);o.push(...i)}}),o}(e);console.log("\uD83D\uDD04 扁平化分类:",a);let n=new Map;a.forEach(e=>{let t=e.level||1;n.has(t)||n.set(t,[]),n.get(t).push(e)});let s=new Map;for(let e of Array.from(n.keys()).sort())for(let i of n.get(e)){console.log("➕ 创建分类:",i.name,"level:",e);let r=null;i.parentId&&s.has(i.parentId)&&(r=s.get(i.parentId));let o=await c.api.recordCategories.createRecordCategory({name:i.name,...r&&{parentId:r},order:i.order||0,enabled:!1!==i.enabled},{applicationId:t,directoryId:es.id});o.success&&o.data?(s.set(i.tempId,o.data.id),console.log("✅ 分类创建成功:",i.name,"ID:",o.data.id)):console.error("❌ 分类创建失败:",i.name,o)}let u=await c.api.recordCategories.getRecordCategories({applicationId:t,directoryId:es.id});if(u.success){let e=eb((null===(r=u.data)||void 0===r?void 0:r.categories)||[]),t={...es,categories:e};U(e=>{var i;return{...e,[(null==el?void 0:el.id)||""]:(null===(i=e[(null==el?void 0:el.id)||""])||void 0===i?void 0:i.map(e=>e.id===es.id?t:e))||[]}}),d({description:"zh"===l?"分类保存成功":"Categories saved successfully"}),G(!1)}else throw Error(u.error||"获取更新后的分类失败")}catch(e){console.error("保存分类失败:",e),d({description:"zh"===l?"保存分类失败，请重试":"Failed to save categories, please try again",variant:"destructive"})}}function eb(e){let t=new Map,i=[];e.forEach(e=>{t.set(e.id,{...e,children:[]})}),e.forEach(e=>{let r=t.get(e.id);e.parentId&&t.has(e.parentId)?t.get(e.parentId).children.push(r):i.push(r)});let r=e=>{e.sort((e,t)=>(e.order||0)-(t.order||0)),e.forEach(e=>{e.children.length>0&&r(e.children)})};return r(i),i}async function eI(e){if(es){if(!i("delete")){d({description:"zh"===l?"当前角色无权删除记录":"Current role has no permission to delete record",variant:"destructive"});return}try{(await c.api.records.deleteRecord(es.id,e)).success&&(await ed(es.id),eo(),d({description:"zh"===l?"记录删除成功":"Record deleted successfully"}))}catch(e){console.error("删除记录失败:",e),d({description:"zh"===l?"删除记录失败":"Failed to delete record",variant:"destructive"})}}}async function eC(){if(es){if(!i("bulkDelete")){d({description:"zh"===l?"当前角色无权批量删除":"Current role has no permission to bulk delete",variant:"destructive"});return}if(0!==S.length&&confirm("zh"===l?"确定要删除选中的 ".concat(S.length," 条记录吗？此操作不可撤销。"):"Are you sure you want to delete ".concat(S.length," selected records? This action cannot be undone.")))try{let e=await c.api.records.bulkDeleteRecords(es.id,S);if(e.success&&e.data){let{deletedCount:t,failedCount:i}=e.data;await ed(es.id),z([]),eo(),0===i?d({description:"zh"===l?"成功删除 ".concat(t," 条记录"):"Successfully deleted ".concat(t," records")}):d({description:"zh"===l?"删除了 ".concat(t," 条记录，").concat(i," 条删除失败"):"Deleted ".concat(t," records, ").concat(i," failed"),variant:"destructive"})}}catch(e){console.error("批量删除记录失败:",e),d({description:"zh"===l?"批量删除记录失败":"Failed to bulk delete records",variant:"destructive"})}}}return(0,r.useEffect)(()=>{es&&"table"===es.type&&(console.log("\uD83D\uDD0D useEffect触发，准备获取记录:",es.id,"类型:",es.type),ed(es.id))},[null==es?void 0:es.id,null==es?void 0:es.type]),(0,r.useEffect)(()=>{z([])},[g,b.kw,b.status,b.category]),(0,r.useEffect)(()=>{v&&d({description:v,variant:"destructive"})},[v,d]),{app:u?{id:u.id,name:u.name,desc:u.description,modules:en}:null,modules:en,currentModule:el,currentDir:es,records:es&&Z[es.id]||[],moduleId:h,setModuleId:y,dirId:g,setDirId:w,filters:b,setFilters:I,tab:C,setTab:k,selectedIds:S,setSelectedIds:z,drawer:D,setDrawer:E,openAddModule:F,setOpenAddModule:M,openAddDir:R,setOpenAddDir:A,openAddField:q,setOpenAddField:x,renameModuleOpen:_,setRenameModuleOpen:N,renameModuleName:O,setRenameModuleName:T,renameDirOpen:K,setRenameDirOpen:V,renameDirName:P,setRenameDirName:L,renameDirTargetId:j,setRenameDirTargetId:B,openCategory:Y,setOpenCategory:G,openCategorySelection:H,setOpenCategorySelection:J,isLoading:p,error:v,refresh:m,listRefreshToken:ei,persist:function(e){try{if(!e||!e.modules)return;U(t=>{let i={...t};for(let r of e.modules||[]){if(!r||!r.id)continue;let e=(r.directories||[]).map(e=>{var i,o,a;let c=(t[r.id]||[]).find(t=>t.id===e.id);return{id:e.id,name:e.name,type:e.type,fields:Array.isArray(e.fields)?e.fields.slice():[],categories:null!==(o=null!==(i=e.categories)&&void 0!==i?i:null==c?void 0:c.categories)&&void 0!==o?o:[],records:null!==(a=null==c?void 0:c.records)&&void 0!==a?a:[]}});i[r.id]=e}return i})}catch(e){console.warn("persist 合并目录数据失败:",e)}},updateDirectoryFields:function(e,t,i){try{U(r=>{let o=(r[e]||[]).map(e=>e.id!==t?e:{...e,fields:Array.isArray(i)?i.slice():[]});return{...r,[e]:o}})}catch(e){console.warn("updateDirectoryFields 失败:",e)}},saveRecord:ep,addRecord:ev,openDrawer:function(e,t){E({open:!0,dirId:e,recordId:t,tab:"basic"})},closeDrawer:function(){E({open:!1,dirId:null,recordId:null,tab:"basic"})},quickOpenAddField:function(){x(!0)},handleCreateModuleFromDialog:ef,handleCreateDirectoryFromDialog:eu,openRenameModule:function(){el&&(T(el.name),N(!0))},handleRenameModule:function(e){if(el){if(!i("edit")){d({description:"zh"===l?"当前角色无权重命名模块":"Current role has no permission to rename module",variant:"destructive"});return}(e||O).trim()&&(d({description:"zh"===l?"重命名模块功能正在开发中":"Rename module feature is under development"}),N(!1))}},renameDir:eh,handleRenameDir:ey,deleteDir:eg,handleSaveCategories:ew,handleSingleDelete:eI,handleBulkDelete:eC,createRecordWithCategory:em}}}}]);